<!doctype html>
<html lang="es">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>B√∫squeda de Municipios - Madrid</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="" crossorigin=""></script>
	<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
	<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

	<style>
		/* --- ESTILOS CONSOLIDADOS --- */
		:root{
			--bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Gradient background */
			--card: linear-gradient(145deg, #ffffff, #f0f4f8); /* Subtle card gradient */
			--accent: #8a2be2; /* Vibrant purple */
			--accent-strong: #ff6b35; /* Bright orange for highlights */
			--accent-secondary: #00d2ff; /* Cyan for accents */
			--muted: #4a5568;
			--separator: rgba(138,43,226,0.1);
			--gap: 12px;
			--shadow: 0 10px 30px rgba(0,0,0,0.1);
			--text-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
        
	    /* body + layout tweaks (from original, enhanced with theme) */
		html,body{height:100vh;width:100vw;margin:0;padding:0;box-sizing:border-box;overflow:hidden;font-family:'Roboto',Inter,Segoe UI,Arial;color:#0f1724;background:var(--bg)}
		.app{display:flex;flex-direction:column;height:100vh}
				
/* Header with absolute rotator */
header{position:relative; padding:20px; background:var(--bg); border-bottom:none; box-shadow:var(--shadow);}
header h1{margin:0 auto; font-size:48px; color:#fff; font-weight:700; white-space:normal; text-align:center; max-width:calc(100vw - 400px); text-shadow:var(--text-shadow); animation:pulse 3s ease-in-out infinite;}
@keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.8; } }
				
		.topbar-search{position:absolute; right:55px; top:50%; transform:translateY(-50%); width:320px}
		.search-input{width:100%;padding:14px 16px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);box-shadow:0 1px 2px rgba(16,24,40,.03);font-size:16px}

		/* Grid Layout */
		.container{flex:1;display:grid;grid-template-columns:0.4fr 1.2fr 0.5fr;grid-template-rows:1fr 420px;gap:var(--gap);padding:14px 14px 46px;min-height:0}
		.left{grid-column:1/2;grid-row:1/2;padding:8px;overflow:auto;}
		.center{grid-column:2/3;grid-row:1/2;background:var(--card);border-radius:10px;padding:6px;display:flex;flex-direction:column;min-height:0;border:1px solid var(--separator);box-shadow:0 2px 5px rgba(16,24,40,.03);transition:transform 0.3s ease, box-shadow 0.3s ease;}
		.center:hover{transform:translateY(-2px);box-shadow:var(--shadow);}
		.right{grid-column:3/4;grid-row:1/2;background:var(--card);padding:8px;border-radius:10px;overflow:auto;border:1px solid var(--separator);box-shadow:0 2px 5px rgba(16,24,40,.03);transition:transform 0.3s ease, box-shadow 0.3s ease;}
		.right:hover{transform:translateY(-2px);box-shadow:var(--shadow);}
		/* allow the right column to shrink on small widths so inputs don't overflow */
		.right{min-width:0}
						
		/* Fila inferior con 3 columnas independientes: Ranking | Descripci√≥n | Chatbot */
		/* Aumentamos la fracci√≥n de la tercera columna para dar m√°s anchura al Chatbot */
		.bottom{grid-column:1/4;grid-row:2/3;display:grid;grid-template-columns:0.4fr 1fr 0.7fr; gap:12px;min-height:0}

		/* Cards y Contenido Scrolleable */
		.bottom .card{height:100%;display:flex;flex-direction:column;overflow:hidden;}
		.card{background:var(--card);border-radius:10px;padding:10px;margin:2px 0;transition:all 0.3s ease;border:1px solid var(--separator);position:relative;}
		.card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.12), 0 0 15px rgba(0,213,255,0.1);border-color:var(--accent-secondary);background:linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);}
						
		.ranking-list-content, .detail-content{
			padding:0 12px 36px 12px; /* Ajuste para scroll y espacio inferior */
			flex:1;
			overflow-y:auto; 
		}

		/* Ajustes espec√≠ficos para el buscador dentro del panel Ranking */
		.ranking-search{display:block;padding:6px 12px}
		.ranking-search .search-input{width:100%;max-width:none;padding:10px 12px;border-radius:8px;box-sizing:border-box}

		/* Ensure inputs and textareas inside the right panel never overflow */
		.right input[type="text"], .right input[type="number"], .right input[type="range"], .right input, .right textarea, #placeInput{ max-width:100%; box-sizing:border-box; }
						
		#map{height:100%;border-radius:8px}

		/* SIMILARES card look */
		.sim-card{
			display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);
			background:linear-gradient(180deg,rgba(255,255,255,0.7),rgba(255,255,255,0.9));
			cursor: pointer;
			transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
		}
		.sim-card:hover{background:linear-gradient(45deg, var(--accent-secondary), var(--accent)); transform:translateY(-2px); box-shadow:var(--shadow); color:#fff;}
		.sim-card .thumb{
			width:56px;height:40px;border-radius:6px;background:#f3f4f6;overflow:hidden;flex:0 0 56px;display:flex;align-items:center;justify-content:center;
		}
		.sim-card .thumb img{width:100%;height:100%;object-fit:cover;display:block;transition:opacity 0.3s}

		/* Slider look and feel */
		.sliders label{display:flex;justify-content:space-between;font-size:13px;margin-top:10px;color:var(--muted)}
	    input[type=range]{-webkit-appearance:none;width:100%;height:8px;border-radius:6px;background:linear-gradient(90deg,#a8c7f0,var(--accent-strong));outline:none}
		input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);box-shadow:0 2px 6px rgba(31,78,121,0.18);border:2px solid #fff;margin-top:-5px}
		input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--accent);border:2px solid #fff}

		/* noUiSlider styling */
		.noUi-target{background:linear-gradient(90deg,#a8c7f0,var(--accent-strong));border-radius:6px;border:none;box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);height:8px}
		.noUi-connect{background:var(--accent)}
		.noUi-handle{border-radius:50%;background:var(--accent);box-shadow:0 2px 6px rgba(31,78,121,0.18);border:2px solid #fff;width:18px;height:18px;right:-9px;top:-5px}
		.noUi-handle:before, .noUi-handle:after{display:none}

		.sep{height:1px;background:var(--separator);margin:12px 0;border-radius:1px}

		/* Sponsor slider inside header */
		.sponsor-rotator{
			position:absolute;
			left:20px;
			top:50%;
			transform:translateY(-50%);
			width: clamp(250px, 20vw, 350px);
			height: clamp(70px, 9vh, 90px);
			overflow-x:hidden;
			overflow-y:hidden;
			background:transparent;
			pointer-events:auto;
			display: flex;
			align-items: center;
		}

		.header-help-btn{
			position:absolute;
			right:20px;
			top:50%;
			transform:translateY(-50%);
			width:40px;
			height:40px;
			border-radius:50%;
			background: var(--accent);
			color:#fff;
			display:flex;
			align-items:center;
			justify-content:center;
			font-size:20px;
			font-weight:700;
			cursor:pointer;
			box-shadow:0 4px 12px rgba(0,0,0,0.2);
			transition:background 0.3s ease, transform 0.2s ease;
		}
		.header-help-btn:hover{
			background: var(--accent-strong);
			transform:scale(1.1);
			box-shadow:0 6px 16px rgba(0,0,0,0.3);
		}

		.sponsor-track{
			display:flex;
			align-items:center;
			gap: clamp(8px, 2vw, 20px);
			padding:0;
			box-sizing:border-box;
			flex-wrap:nowrap;
			min-width: max-content;
			animation:slide-left 6s linear infinite;
		}

		.sponsor-track img{
			height: clamp(30px, 4vh, 48px);
			width:auto;
			display:inline-block;
			object-fit:contain;
			opacity:1;
			transition:transform .25s ease, opacity .25s ease;
			flex:0 0 auto;
		}

		@keyframes slide-left{
			0% { transform:translateX(0); }
			100% { transform:translateX(-50%); }
		}

		/* Mobile adjustments */
		@media (max-width:900px){
			.container{grid-template-columns:1fr;grid-template-rows:minmax(0, 1fr) 1fr 320px 360px; }
			.left{grid-column:1/2;grid-row:3/4; height: 320px;}
			.right{grid-column:1/2;grid-row:2/3}
			.center{grid-column:1/2;grid-row:1/2}
			.bottom{grid-row:4/5;grid-column:1/2;grid-template-columns:1fr;}

			header {
				flex-direction: column;
				align-items: flex-start;
				padding: 10px 18px 18px 18px;
				min-height: 100px;
			}
			header h1 {
				font-size: 24px;
				order: 2;
				margin-top: 12px;
			}
			.topbar-search{
				position: static;
				width: 100%;
				margin-top: 10px;
				order: 3;
				transform: none;
			}

			.sponsor-rotator{
				position: static;
				width: 100%;
				height: 56px;
				left: auto;
				top: auto;
				overflow-x: auto;
				order: 1;
			}
			.sponsor-track{
				animation: none;
				gap: 16px;
				padding: 0 0 0 4px;
			}
			.sponsor-track img{
				height: 48px;
			}
		}
		@media (max-width:700px){
			header {
				flex-direction: column;
				gap: 10px;
			}
			header h1 {
				flex: none;
				text-align: left;
				line-height: 1.2;
				margin: 0;
				font-size: 22px;
			}
			.sponsor-rotator {
				width: 100%;
				margin-bottom: 5px;
			}
		}

		.ranking-item{display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px dashed var(--separator);cursor:pointer;transition:background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;border-radius:6px;margin:2px 0;}
		.ranking-item .thumb{width:56px;height:40px;border-radius:6px;background:#f3f4f6;overflow:hidden;flex:0 0 56px;display:flex;align-items:center;justify-content:center;}
		.ranking-item .thumb img{width:100%;height:100%;object-fit:cover;display:block;transition:opacity 0.3s}
		.ranking-item:hover{background:linear-gradient(135deg, #e0f7fa, #b2ebf2);transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.1);}
		.muted{color:var(--muted);font-size:13px}
		.ranking-item.selected{background:linear-gradient(90deg,var(--accent),var(--accent-secondary));color:#fff;border-left:4px solid var(--accent-strong);box-shadow:0 4px 12px rgba(0,0,0,0.2);}
		.ranking-item.selected:hover{background:linear-gradient(90deg, rgba(138,43,226,0.8), rgba(0,213,255,0.8));transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,0.3);}
		.ranking-item:hover strong{color:var(--accent);}

		.detail-table{width:100%;border-collapse:collapse;margin-top:8px;margin-bottom:8px;border:1px solid rgba(3,61,74,0.08);box-shadow:0 1px 0 rgba(0,0,0,0.03)}
		.detail-table th{background:rgba(3,61,74,0.04);color:var(--accent-strong);font-weight:700;padding:8px 10px;border:1px solid rgba(3,61,74,0.12);text-align:left;font-size:13px}
		.detail-table td{padding:8px 10px;border:1px solid rgba(3,61,74,0.08);font-size:13px;background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96))}

		/* etiqueta fija sobre la ruta */
		.route-label{
			background: rgba(0,0,0,0.7);
			color: #fff;
			padding:6px 8px;border-radius:6px;font-weight:700;font-size:13px;box-shadow:0 2px 6px rgba(0,0,0,0.25);
		}

		/* Custom scrollbar styling - remove white rectangle backgrounds */
		/* Webkit browsers (Chrome, Safari, Edge) */
		.ranking-list-content::-webkit-scrollbar,
		.detail-content::-webkit-scrollbar,
		#chatbot .messages::-webkit-scrollbar {
			width: 16px;
			background: transparent;
		}

		.ranking-list-content::-webkit-scrollbar-track,
		.detail-content::-webkit-scrollbar-track,
		#chatbot .messages::-webkit-scrollbar-track {
			background: transparent;
			border-radius: 4px;
		}

		.ranking-list-content::-webkit-scrollbar-thumb,
		.detail-content::-webkit-scrollbar-thumb,
		#chatbot .messages::-webkit-scrollbar-thumb {
			background: rgba(0,213,255,0.3);
			border-radius: 4px;
		}

		.ranking-list-content::-webkit-scrollbar-thumb:hover,
		.detail-content::-webkit-scrollbar-thumb:hover,
		#chatbot .messages::-webkit-scrollbar-thumb:hover {
			background: rgba(0,213,255,0.5);
		}

		/* Firefox */
		* {
			scrollbar-width: thick;
			scrollbar-color: rgba(0,213,255,0.3) transparent;
		}

		/* Municipality description justification */
		#detailDesc {
			text-align: justify;
		}

		/* Map pop-ups justification */
		.leaflet-popup-content {
			text-align: justify;
		}

		/* Chatbot messages justification */
		.message .bubble {
			text-align: justify;
		}

		/* Modal styles */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 10000;
		}
		.modal {
			background: #fff;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
			max-width: 500px;
			font-size: 14px;
			line-height: 1.5;
			text-align: justify;
			position: relative;
		}
		.modal button {
			margin-top: 15px;
			padding: 8px 16px;
			background: var(--accent);
			color: #fff;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}

		/* Chatbot styles */
		/* Make the chat container use flex so messages area stays scrollable
		   and the input/button remain pinned to the bottom. */
		#chatbot { display:flex; flex-direction:column; flex:1; min-height:0; gap:8px; }
		#chatbot .chat-controls{display:flex;gap:8px;align-items:center;padding:0 6px}
		/* Allow messages area to shrink and scroll without pushing the input */
		#chatbot .messages{flex:1; min-height:0; overflow:auto; padding:10px; background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)); border-radius:6px; border:1px solid rgba(3,61,74,0.04)}
		.message{margin-bottom:10px;max-width:100%;display:flex}
		.message.user{justify-content:flex-end}
		.message .bubble{padding:10px 12px;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.05);font-size:17px}
		.message.user .bubble{background:#2b7be4;color:#fff;border-bottom-right-radius:2px}
		.message.assistant .bubble{background:#f3f4f6;color:#0f1724;border-bottom-left-radius:2px}
		.chat-input{display:flex;gap:8px;padding:6px; flex:0 0 auto}
		.chat-input textarea{flex:1;resize:none;padding:8px;border-radius:8px;border:1px solid var(--separator);min-height:42px}
		.chat-input button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;transition:background 0.3s ease, transform 0.2s ease;}
		.chat-input button:hover{background:var(--accent-strong);transform:scale(1.05);}
		.api-key{flex:1;display:flex;gap:6px;align-items:center}
		.api-key input{flex:1;padding:6px;border-radius:6px;border:1px solid var(--separator)}
		
	</style>
</head>
<body>
	<div class="app">

	<header>
			<div class="title-container">
				<h1>Tu Municipio Ideal: Un Asistente para Decidir con Datos</h1>
			</div>
			<div class="sponsor-rotator" id="sponsorRot">
				<div class="sponsor-track" id="sponsorTrack">
					<img src="logos/logo1.png" alt="Patrocinador 1">
					<img src="logos/logo2.png" alt="Patrocinador 2">
					<img src="logos/logo3.png" alt="Patrocinador 3">
					<img src="logos/logo1.png" alt="Patrocinador 1">
					<img src="logos/logo2.png" alt="Patrocinador 2">
					<img src="logos/logo3.png" alt="Patrocinador 3">
				</div>
			</div>
			<div class="header-help-btn" onclick="showHelpModal()">?</div>
		</header>

		<main class="container">
			<aside class="left card">
				<h3>RANKING EN BASE A PREFERENCIAS</h3>
				<div class="ranking-search" style="padding:0 12px">
					<input class="search-input" id="mainSearch" placeholder="B√∫squeda de municipios ‚û§ " />
				</div>
				<div id="ranking" class="ranking-list-content"></div>
			</aside>

			<section class="center"> 
				<div style="flex:1;min-height:0">
					<div id="map" style="height:100%"></div>
				</div>
			</section>

			<aside class="right"> 
				<h3>¬øCU√ÅNTO VALORAS...?</h3>
				<div class="sliders">
					<label>Educaci√≥n <span id="val-educ">5</span></label>
					<input type="range" id="s-educ" min="0" max="10" value="5" />

					<label>Sanidad <span id="val-sani">5</span></label>
					<input type="range" id="s-sani" min="0" max="10" value="5" />

					<label>Ocio y cultura <span id="val-ocio">5</span></label>
					<input type="range" id="s-ocio" min="0" max="10" value="5" />

					<label>Bienestar <span id="val-cost">5</span></label>
					<input type="range" id="s-cost" min="0" max="10" value="5" />

					<label>Servicios <span id="val-serv">5</span></label>
					<input type="range" id="s-serv" min="0" max="10" value="5" />

					<label>Movilidad <span id="val-mov">5</span></label>
					<input type="range" id="s-mov" min="0" max="10" value="5" />

					<label>Econom√≠a y empleo <span id="val-econ">5</span></label>
					<input type="range" id="s-econ" min="0" max="10" value="5" />
				</div>

				<!-- Rango de poblaci√≥n: min / max -->
				<div style="margin-top:8px;">
					<label style="display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted)">
						<span>Poblaci√≥n (rango)</span>
						<span class="muted"><strong><span id="popMinVal">0</span> ‚Äî <span id="popMaxVal">0</span></strong></span>
					</label>
					<div id="population-slider" style="margin-top:6px; width:90%; margin-left:auto; margin-right:auto;"></div>
				</div>

				<hr class="sep" />
				<h4>Distancia de viaje desde municipio hacia ...</h4>
				<input id="placeInput" placeholder="Introduce una ubicaci√≥n que visites frecuentemente" style="width:100%;padding:10px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);margin-bottom:12px" />

				<button id="buscarBtn" style="width:100%;padding:10px 12px;background:var(--accent);color:#fff;border:none;border-radius:6px;margin-top:12px">Buscar</button>

				<div style="margin-top:12px;margin-bottom:8px">
					<input type="checkbox" id="colorZones" checked>
					<label for="colorZones" style="margin-left:6px;margin-top:0">Colorear zonas (aprox.)</label>
				</div>

				<div style="margin-top:8px;display:flex;align-items:center;margin-bottom:8px;gap:8px">
					<label style="margin-right:8px;color:var(--muted);margin-top:0">Mostrar en mapa:</label>
					<input type="range" id="mapLimitSlider" min="1" max="10" value="10" style="flex:1">
					<div style="min-width:54px;text-align:right;color:var(--muted)"><strong id="mapLimitVal">10</strong></div>
				</div>
				
				<div style="margin-top:6px">
					<input type="checkbox" id="showAllMap">
					<label for="showAllMap" style="margin-left:6px;margin-top:0">Mostrar todas en mapa</label>
				</div>

				<div style="margin-top:8px">
					<input type="checkbox" id="useRouting">
					<label for="useRouting" style="margin-left:6px;margin-top:0">Trazar ruta por carretera (OSRM)</label>
				</div>
			</aside>

			<section class="bottom">
				<div class="card">
					<h3 id="similares-title">SIMILARES A MUNICIPIO QUE SE ELIGE</h3>
					<label>N√∫mero de similares a mostrar: <span id="val-similares">10</span></label>
					<input type="range" id="s-similares" min="1" max="10" value="10" />
					<hr class="sep" />
					<div id="similaresList" class="ranking-list-content">
					</div>
				</div>
			
				<div class="card"> 
					<h3 id="detailTitle" style="padding:0 12px">Selecciona un municipio</h3>
					<div id="detailContent" class="detail-content"> 
						<div id="detailProfile" class="muted">
							<table class="detail-table">
								<thead><tr><th>Educaci√≥n</th><th>Sanidad</th><th>Ocio y cultura</th><th>Bienestar</th><th>Servicios</th><th>Transporte y conectividad</th><th>Econom√≠a y empleo</th><th>Poblaci√≥n</th></tr></thead>
								<tbody><tr><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td></tr></tbody>
							</table>
						</div>
						<div id="detailRoute" class="muted" style="margin-top:6px"></div>
						<h4>BREVE DESCRIPCI√ìN DEL MUNICIPIO</h4>
						<p id="detailDesc">Aqu√≠ aparecer√° una peque√±a descripci√≥n cuando selecciones un municipio del ranking.</p>
					</div>
				</div>
			
				<div class="card" id="chatbot-placeholder">
					<h3 style="padding:0 12px">ChatBot Asistente</h3>
					<div id="chatbot">
						<!-- chat-controls removed per request -->
						<div class="messages" id="chatMessages" aria-live="polite"></div>
						<div class="chat-input">
							<textarea id="chatInput" placeholder="Escribe tu pregunta aqu√≠..."></textarea>
							<button id="sendChatBtn">Enviar</button>
						</div>
					</div>
				</div>
			</section>
		</main>
		</div>

		<!-- Modal for info explanation -->
		<div id="infoModal" class="modal-overlay" style="display:none;">
			<div class="modal">
				<p></p>
				<button onclick="hideInfoModal()">Cerrar</button>
			</div>
		</div>

		<!-- Modal for help explanation -->
		<div id="helpModal" class="modal-overlay" style="display:none;">
			<div class="modal">
				<p></p>
				<button onclick="hideHelpModal()">Cerrar</button>
			</div>
		</div>

		<!-- Load local secrets (secrets.js) which defines window.SECRETS.OPENROUTER_API_KEY -->
		<script src="secrets.js"></script>
		<script>
		// app state
		let municipios = [];
		let similaresData = []; // Para almacenar los datos de municipios_similares.csv
		let conversationHistory = []; // Historial de conversaci√≥n para mantener memoria en el chatbot
		// Ruta base para los datos (permite cambiar f√°cilmente la carpeta de origen)
		const DATA_PATH = 'website_data/';
		const markers = {};
		let populationSlider;

		// Map setup (Leaflet already included)
		const map = L.map('map', {zoomControl:true}).setView([40.4168,-3.7038],10);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(map);

		const markerLayer = L.layerGroup().addTo(map);
		let currentRankMarkers = {}; 
		let lastSortedMap = {}; 
		const areaLayer = L.layerGroup().addTo(map);
		// layer to show the user's "Lugar de Inter√©s" (single red marker)
		const interestLayer = L.layerGroup().addTo(map);
		// layer to draw connection line between selected municipio and interest point
		const connectionLayer = L.layerGroup().addTo(map);
		// layer to draw routed path (OSRM)
		const routeLayer = L.layerGroup().addTo(map);
		let municipioMap = {}; // Mapa para acceder r√°pidamente a un municipio por nombre

		// Funcionalidad del bot√≥n Buscar (ahora en el HTML)
		const buscarBtn = document.getElementById('buscarBtn');
		buscarBtn.onclick = async ()=>{
			try{
				buscarBtn.disabled = true;
				buscarBtn.textContent = 'Buscando...';
				await runSearch({forceReload:true});
			}catch(e){
				console.error('Error en buscar:', e);
				alert('Error al buscar. Mira la consola para m√°s detalles.');
			}finally{
				buscarBtn.disabled = false;
				buscarBtn.textContent = 'Buscar';
			}
		};

		// Auto-run search when map option checkboxes change
		document.querySelectorAll('.right input[type="checkbox"]').forEach(input=>{
			input.addEventListener('change', ()=>{ try{ runSearch({forceReload:false}); }catch(e){ console.error('runSearch error from change', e); } });
		});

		// Map limit slider (will have its max updated after CSV loads)
		const mapLimitSlider = document.getElementById('mapLimitSlider');
		if(mapLimitSlider){
			mapLimitSlider.addEventListener('input', ()=>{ document.getElementById('mapLimitVal').textContent = mapLimitSlider.value; });
			mapLimitSlider.addEventListener('change', ()=>{ try{ runSearch({forceReload:false}); }catch(e){ console.error('mapLimit change runSearch error', e); } });
		}

		// Auto-run search when similares slider changes
        document.getElementById('s-similares').addEventListener('change', ()=>{
            // Llamar a la funci√≥n de similares con el municipio seleccionado o el rank 1
            const currentSelected = document.querySelector('.ranking-item.selected');
            if (currentSelected) {
                const id = parseInt(currentSelected.id.split('-')[2]);
                const m = lastSortedMap[id] || municipios.find(x=>x.id===id);
                if (m) {
                    updateSimilaresFromCSV(m.name);
                    return;
                }
            }
			// Fallback: usar el rank 1
            if (lastSortedMap && Object.keys(lastSortedMap).length > 0) {
                 const rank1 = Object.values(lastSortedMap).sort((a,b)=>b.score - a.score)[0];
                 if(rank1) updateSimilaresFromCSV(rank1.name);
            } else {
                 updateSimilaresFromCSV(null); // Borrar la lista si no hay ranking
            }
        });

		// mapping of slider keys to CSV columns
		const columnMap = { educ:'educacion', sani:'sanidad', ocio:'ocio_cultura', cost:'bienestar', serv:'servicios', mov:'transporte_conectividad', econ:'economia_empleo' };

		// load CSV 
		let csvLoaded = false;
		function loadCSV(){
			return new Promise((resolve, reject)=>{
				if(csvLoaded) return resolve();
				Papa.parse(DATA_PATH + 'df_indices_categorias.csv', {
					download: true,
					header: true,
					dynamicTyping: true,
					skipEmptyLines: true,
					complete: function(results){
						municipios = results.data.map((r, i)=>({
							id: i+1,
							cod: r.cod_municipio,
							name: r.municipio || r.nombre || `Municipio ${i+1}`,
							lat: Number(r.latitud) || Number(r.latitude) || null,
							lon: Number(r.longitud) || Number(r.longitude) || null,
							alt: Number(r.altitud) || null,
							sanidad: Number(r.sanidad) || 0,
							educacion: Number(r.educacion) || 0,
							transporte_conectividad: Number(r.transporte_conectividad) || 0,
							economia_empleo: Number(r.economia_empleo) || 0,
							bienestar: Number(r.bienestar) || 0,
							servicios: Number(r.servicios) || 0,
							ocio_cultura: Number(r.ocio_cultura) || 0,
							poblacion: Number(r.poblacion) || 0,
							desc: r.descripcion || r.Descripcion || r.description || r.Description || ''
						}));
						csvLoaded = true;
						municipioMap = {}; // Reset map
						municipios.forEach(m=>{
							if(m.name) municipioMap[m.name.toLowerCase()] = m; // Llenar el mapa con clave lowercase
						});
                        resolve();
					},
					error: function(err){
						console.error('CSV load error', err);
						reject(err);
					}
				});
			});
		}

		// NUEVA: Cargar CSV de Similares
        let similaresLoaded = false;
        function loadSimilaresCSV(){
            return new Promise((resolve, reject)=>{
                if(similaresLoaded) return resolve();
				Papa.parse(DATA_PATH + 'municipios_similares.csv', {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results){
                        similaresData = results.data;
                        similaresLoaded = true;
                        resolve();
                    },
                    error: function(err){
                        console.error('Similares CSV load error', err);
                        // Fallback: usar los primeros 3 municipios del ranking como antes
                        similaresData = []; 
                        reject(err);
                    }
                });
            });
        }

		// fallback mock 
		function loadFallback(){
			municipios = [
				{id:1,name:'Alcal√° de Henares',lat:40.481,lon:-3.363,educacion:8, sanidad:7, ocio_cultura:8, bienestar:6, transporte_conectividad:7, economia_empleo:7, desc:'Ciudad universitaria y con buena oferta cultural.'},
				{id:2,name:'Majadahonda',lat:40.453,lon:-3.873,educacion:7, sanidad:8, ocio_cultura:6, bienestar:6, transporte_conectividad:8, economia_empleo:6, desc:'Municipio residencial con buen acceso a Madrid.'},
				{id:3,name:'Getafe',lat:40.308,lon:-3.732,educacion:6, sanidad:6, ocio_cultura:7, bienestar:6, transporte_conectividad:7, economia_empleo:8, desc:'Ciudad con gran actividad industrial y universitaria.'}
			];
			municipioMap = {};
			municipios.forEach(m=>{ if(m.name) municipioMap[m.name.toLowerCase()] = m; });
            csvLoaded = false;
		}

		// compute scores - accepts an optional list of municipios to score
		function computeScores(weights, sourceMunicipios){
			const baseList = (Array.isArray(sourceMunicipios) && sourceMunicipios.length) ? sourceMunicipios : municipios;
			const scored = baseList.map(m=>{
				let s = 0;
				Object.keys(columnMap).forEach(k=>{
					const col = columnMap[k];
					const w = weights[k] || 0;
					const v = isFinite(m[col])? m[col] : 0; 
					s += w * v;
				});
				return {...m, score: s };
			});
			return scored.sort((a,b)=>b.score - a.score);
		}

		// create numbered marker 
		function createNumberedMarker(m, rank){
			const numberHtml = `<div style="background:${rank===1?'#ffc107':'#2b7be4'};color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid #fff;box-shadow:0 1px 2px rgba(0,0,0,.2)">${rank}</div>`;
			const icon = L.divIcon({className:'number-icon', html:numberHtml, iconSize:[30,30], iconAnchor:[15,30]});
			const marker = L.marker([m.lat,m.lon], {icon}).bindPopup(`<strong>#${rank} ${m.name}</strong><br/>Puntuaci√≥n: ${(m.score*100).toFixed(1)}`);
			return marker;
		}

		// map score to color 
		function scoreToColor(score){
			const s = Math.max(0, Math.min(1, score));
			function lerpColor(a,b,t){
				return [
					Math.round(a[0] + (b[0]-a[0])*t),
					Math.round(a[1] + (b[1]-a[1])*t),
					Math.round(a[2] + (b[2]-a[2])*t)
				];
			}
			const red = [220,53,69]; 
			const yellow = [255,215,0];
			const green = [34,139,34]; 
			let rgb;
			if(s < 0.5){
				const t = s / 0.5;
				rgb = lerpColor(red, yellow, t);
			} else {
				const t = (s - 0.5) / 0.5;
				rgb = lerpColor(yellow, green, t);
			}
			return `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
		}

		// display names
		const displayNames = {
			'educacion': 'Educaci√≥n',
			'sanidad': 'Sanidad',
			'ocio_cultura': 'Ocio y cultura',
			'bienestar': 'Bienestar',
			'servicios': 'Servicios',
			'transporte_conectividad': 'Transporte y conectividad',
			'economia_empleo': 'Econom√≠a y empleo',
			'poblacion': 'Poblaci√≥n'
		};

		// render ranking
		function renderRanking(sorted, mapLimit=20){
            const list = document.getElementById('ranking');
            list.innerHTML = '';

            markerLayer.clearLayers();
            currentRankMarkers = {};
            areaLayer.clearLayers();
            lastSortedMap = {};

            sorted.forEach((m, idx)=>{
                lastSortedMap[m.id] = m;
                const rank = idx+1;
                const div = document.createElement('div');
                div.className = 'ranking-item';
                div.id = 'ranking-item-' + m.id;
                const scoreText = isFinite(m.score)? `(Puntuaci√≥n: ${(m.score*100).toFixed(1)})` : '';

                const thumbDiv = document.createElement('div');
                thumbDiv.className = 'thumb';
                thumbDiv.innerHTML = '<svg width="56" height="40" viewBox="0 0 56 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="56" height="40" rx="6" fill="#f3f4f6"/></svg>';
                div.appendChild(thumbDiv);

                const content = document.createElement('div');
                content.style.flex = '1';
                content.innerHTML = `<strong>#${rank} ${m.name}</strong> <div class="muted">${scoreText}</div>`;
                div.appendChild(content);

                fetchWikiThumbnail(m.name).then(imgUrl=>{
                    const img = document.createElement('img');
                    img.alt = m.name;
                    img.src = imgUrl || 'assets/municipio-placeholder.jpg';
                    img.onerror = () => { img.src = 'assets/municipio-placeholder.jpg'; };
                    thumbDiv.innerHTML = '';
                    thumbDiv.appendChild(img);
                }).catch(()=>{ thumbDiv.innerHTML = `<img src="assets/municipio-placeholder.jpg" alt="${m.name}" onerror="this.src='assets/municipio-placeholder.jpg'">`; });

                div.onclick = ()=> {
                    selectRankingItem(m.id);
                    updateSimilaresFromCSV(m.name); // NUEVO: Actualizar similares al hacer clic
                };
                div.onmouseenter = ()=> { if(currentRankMarkers[m.id]) currentRankMarkers[m.id].openPopup(); };
                div.onmouseleave = ()=> { if(currentRankMarkers[m.id]) currentRankMarkers[m.id].closePopup(); };
                list.appendChild(div);

                if(idx < mapLimit && m.lat && m.lon){
                    const mrk = createNumberedMarker(m, rank);
                    mrk.addTo(markerLayer);
                    mrk.on('click', ()=> {
                        selectRankingItem(m.id);
                        updateSimilaresFromCSV(m.name); // NUEVO: Actualizar similares al hacer clic en marcador
                    });
                    currentRankMarkers[m.id] = mrk;
                    const enableColor = document.getElementById('colorZones')?.checked;
                    if(enableColor){
                        const radius = 1250;
                        const c = L.circle([m.lat,m.lon], {radius: radius, color: scoreToColor(m.score), fillColor: scoreToColor(m.score), fillOpacity: 0.25, weight:1}).bindPopup(`<strong>#${rank} ${m.name}</strong><br/>Puntuaci√≥n: ${(m.score*100).toFixed(1)}`);
                        c.addTo(areaLayer);
                        c.on('click', ()=> {
                             selectRankingItem(m.id);
                             updateSimilaresFromCSV(m.name); // NUEVO: Actualizar similares al hacer clic en zona
                        });
                    }
                }
            });

			// Mostrar similares para el Rank 1 por defecto
            if (sorted.length > 0) {
                updateSimilaresFromCSV(sorted[0].name); 
                selectRankingItem(sorted[0].id); // Seleccionar el rank 1 por defecto
            } else {
                updateSimilaresFromCSV(null);
            }
        }

		// show detail
		const explanation = `<h3>üìä ¬øQu√© aspectos se tienen en cuenta para calcular los √≠ndices?</h3>
<p>Las puntuaciones que ves en la tabla de detalles (como "Educaci√≥n: 85%") son <strong>√≠ndices normalizados de 0 a 100%</strong>, donde 100% indica el mejor desempe√±o posible en esa categor√≠a para los municipios de la Comunidad de Madrid. Estos √≠ndices se basan en datos reales oficiales y combinan varios aspectos relacionados para formar una evaluaci√≥n equilibrada. A continuaci√≥n, te explicamos brevemente qu√© aspectos se consideran para cada categor√≠a y qu√© representan:</p>
<ul>
<li><strong>Educaci√≥n</strong>: N√∫mero de escuelas infantiles y colegios/institutos, incluyendo sus valoraciones promedio de Google. Representa la oferta educativa y la opini√≥n p√∫blica sobre los centros educativos.</li>
<li><strong>Sanidad</strong>: N√∫mero de m√©dicos de familia y farmacias, incluidas sus valoraciones promedio de Google, m√°s centros de salud disponibles. Indica la accesibilidad y calidad percibida de la atenci√≥n m√©dica primaria.</li>
<li><strong>Ocio y cultura</strong>: N√∫mero de restaurantes, bares, cafeter√≠as y cines, con sus valoraciones promedio de Google, m√°s intereses culturales (museos, teatros, etc.). Mide la vitalidad social y la oferta de entretenimiento y cultura.</li>
<li><strong>Bienestar</strong>: N√∫mero de gimnasios y parques (en escala logar√≠tmica), incluyendo sus valoraciones promedio de Google, m√°s √≠ndices de calidad del aire (PM10, PM2.5, O3, NO2, CO, ...). Representa la promoci√≥n de la salud f√≠sica, espacios verdes y calidad ambiental.</li>
<li><strong>Servicios</strong>: N√∫mero de bancos, cajeros, centros comerciales, tiendas de conveniencia, supermercados, gasolineras, bomberos (log) y comisarias (log), con sus valoraciones promedio de Google. Cubre instituciones financieras, comercio cotidiano, seguridad y servicios de emergencia.</li>
<li><strong>Transporte y conectividad</strong>: N√∫mero de paradas de bus y estaciones principales (en escala logar√≠tmica), incluyendo sus valoraciones promedio de Google. Indica la disponibilidad y calidad del transporte p√∫blico.</li>
<li><strong>Econom√≠a y empleo</strong>: N√∫mero de afiliados en agricultura, construcci√≥n, miner√≠a/industria, servicios varios, servicios empresariales/financieros y distribuci√≥n/hosteler√≠a, total de paro registrado, y renta municipal (escala logar√≠tmica). Mide el dinamismo econ√≥mico, diversidad laboral y prosperidad por habitante.</li>
</ul>
<p>Estos √≠ndices se normalizan para comparar municipios de manera justa, considerando factores como poblaci√≥n y densidad.</p>`;

		function showDetail(m){
		    document.getElementById('detailTitle').textContent = m.name;
		    // Build a table of categories
		    const cols = ['educacion','sanidad','ocio_cultura','bienestar','servicios','transporte_conectividad','economia_empleo','poblacion'];
		    const headers = cols.map(c=> displayNames[c] || c.replace('_',' '));
		    const values = cols.map(c=>{
		        const v = (c in m) ? m[c] : null;
		        if(c === 'poblacion'){
		            return (v === null || v === undefined || !isFinite(v)) ? '‚Äî' : v.toString();
		        } else {
		            return (v === null || v === undefined || !isFinite(v)) ? '‚Äî' : (Number(v) * 100).toFixed(0);
		        }
		    });

		    // Calculate average of valid numeric values (multiply by 100), excluding poblacion
		    const colsExcludingPoblacion = cols.filter(c => c !== 'poblacion');
		    const validValues = [];
		    for(const c of colsExcludingPoblacion){
		        const v = (c in m) ? m[c] : null;
		        if(v !== null && v !== undefined && isFinite(v)){
		            validValues.push(Number(v) * 100);
		        }
		    }
		    const average = validValues.length > 0 ? Math.round(validValues.reduce((sum, val) => sum + val, 0) / validValues.length) : '‚Äî';

		    // Add average header and value
		    headers.push('Promedio');
		    values.push(average);

		    // Add Info header and value
		    headers.push('Info');
		    values.push('<button onclick="showInfoModal()" style="padding: 4px 8px; background: rgba(0,0,0,0.08); border: none; border-radius: 3px; cursor: pointer;">?</button>');
		    // Render table into detailProfile
		    const table = document.createElement('table');
		    table.className = 'detail-table';
		    const thead = document.createElement('thead');
		    const trh = document.createElement('tr');
		    headers.forEach(h=>{ const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
		    thead.appendChild(trh);
		    const tbody = document.createElement('tbody');
		    const trv = document.createElement('tr');
		    values.forEach(v=>{ const td = document.createElement('td'); td.innerHTML = v; trv.appendChild(td); });
		    tbody.appendChild(trv);
		    table.appendChild(thead); table.appendChild(tbody);
		    const profileEl = document.getElementById('detailProfile');
		    profileEl.innerHTML = '';
		    profileEl.appendChild(table);

		    document.getElementById('detailDesc').textContent = m.desc || '';
			if(m.lat && m.lon){ map.setView([m.lat,m.lon],12);
		        // Abrir popup si el municipio tiene un marcador de ranking
		        if(currentRankMarkers[m.id]) currentRankMarkers[m.id].openPopup(); 
		        // Si no est√° en el ranking visible, a√±adir un marcador temporal si tiene coordenadas.
		        else if (!currentRankMarkers[m.id]){
					const mapLimitDisplay = document.getElementById('mapLimitSlider') ? document.getElementById('mapLimitSlider').value : document.getElementById('mapLimit')?.value;
					const popupText = isFinite(m.score) ? `<strong>${m.name}</strong><br/>Puntuaci√≥n: ${(m.score*100).toFixed(1)}` : `<strong>${m.name}</strong><br/>No en el top ${mapLimitDisplay}`;
					const tempMarker = L.marker([m.lat,m.lon]).addTo(markerLayer).bindPopup(popupText).openPopup();
		            // Opcional: Centrar el mapa en √©l.
		            map.setView([m.lat,m.lon],12);
		        }
				// Si hay un marcador de inter√©s, dibujar la l√≠nea de conexi√≥n
				try{
					const interestLayers = interestLayer.getLayers();
					if(interestLayers && interestLayers.length>0){
						const il = interestLayers[0].getLatLng();
						drawConnectionBetween(m, il);
					} else {
						connectionLayer.clearLayers();
					}
				}catch(e){ console.warn('drawConnection error', e); }
		    }
		}

		// Dibuja una l√≠nea (o ruta) entre el municipio y el punto de inter√©s (interestLatLng puede ser L.LatLng)
		async function drawConnectionBetween(municipioObj, interestLatLng){
			connectionLayer.clearLayers();
			routeLayer.clearLayers();
			if(!municipioObj || !interestLatLng) return;
			const a = (municipioObj.lat && municipioObj.lon) ? [municipioObj.lat, municipioObj.lon] : null;
			let b = null;
			if(interestLatLng.lat !== undefined){ b = [interestLatLng.lat, interestLatLng.lng !== undefined ? interestLatLng.lng : (interestLatLng.lon || interestLatLng[1])]; }
			if(!a || !b) return;
			// Si el usuario ha marcado usar routing, intentarlo con OSRM. Si falla, dibujar polyline simple.
			const useRouting = document.getElementById('useRouting')?.checked;
			if(useRouting){
				const ok = await routeBetweenPoints(a[0], a[1], b[0], b[1]);
				if(ok) return; // ruta dibujada por OSRM (lastRouteInfo ya configurado)
			}
			// Fallback: l√≠nea simple (distancia en l√≠nea recta)
			const poly = L.polyline([a,b], {color:'#dc3545', weight:3, dashArray:'6 4'}).addTo(connectionLayer);
			// calcular distancia Haversine
			function haversine(lat1,lon1,lat2,lon2){
				const R = 6371000; // m
				const toRad = v => v * Math.PI/180;
				const dLat = toRad(lat2-lat1);
				const dLon = toRad(lon2-lon1);
				const a1 = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
				const c = 2 * Math.atan2(Math.sqrt(a1), Math.sqrt(1-a1));
				return R * c;
			}
			const dist = haversine(a[0],a[1],b[0],b[1]);
			lastRouteInfo = {distance: dist, duration: null, source: 'straight'};
			updateDetailRoute();
			// a√±adir etiqueta sobre la l√≠nea en el punto medio
			try{
				const mid = [(a[0]+b[0])/2, (a[1]+b[1])/2];
				const labelText = `L√≠nea: ${(dist/1000).toFixed(2)} km`;
				poly.bindTooltip(labelText, {permanent:true, direction:'center', className:'route-label', offset:[0,0]}).openTooltip(mid);
			}catch(e){/* ignore */}
			try{ const bounds = L.latLngBounds([a,b]); map.fitBounds(bounds.pad(0.15)); }catch(e){}
		}

		// select ranking item 
		function selectRankingItem(idOrName){
            let m;
            if(typeof idOrName === 'number'){
                const el = document.getElementById('ranking-item-' + idOrName);
                document.querySelectorAll('.ranking-item.selected').forEach(x=>x.classList.remove('selected'));
                if(el){
                    el.classList.add('selected');
                    try{ el.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
                }
                m = lastSortedMap[idOrName] || municipios.find(x=>x.id===idOrName);
            } else if(typeof idOrName === 'string'){
                m = municipioMap[idOrName];
                document.querySelectorAll('.ranking-item.selected').forEach(x=>x.classList.remove('selected'));
                // Si el municipio seleccionado por nombre *est√°* en el ranking actual, lo marcamos.
                const rankItem = Object.values(lastSortedMap).find(item => item.name === idOrName);
                if(rankItem) {
                    const el = document.getElementById('ranking-item-' + rankItem.id);
                    if(el) {
                         el.classList.add('selected');
                         try{ el.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
                    }
                }
            }
            
            if(m) showDetail(m);
        }

		// get slider weights 
		function getSliderWeights(){
			const prefs = {
				educ: Number(document.getElementById('s-educ').value),
				sani: Number(document.getElementById('s-sani').value),
				ocio: Number(document.getElementById('s-ocio').value),
				cost: Number(document.getElementById('s-cost').value),
				serv: Number(document.getElementById('s-serv').value),
				mov: Number(document.getElementById('s-mov').value),
				econ: Number(document.getElementById('s-econ').value)
			};
			const vals = Object.values(prefs);
			const sum = vals.reduce((a,b)=>a+b,0) || 1;
			const weights = {};
			Object.keys(prefs).forEach(k=> weights[k] = prefs[k]/sum);
			return weights;
		}

		// run search
		async function runSearch(opts={}){
            console.log('runSearch called', opts);
            try{
                if(opts.forceReload) csvLoaded = false;
				await loadCSV().catch(()=>{ loadFallback(); });

				// After CSV loads, initialize population sliders (min/max) and compute filtered list
				try{
					// derive min/max from available data
					const popVals = municipios.map(m=> isFinite(m.poblacion) ? Number(m.poblacion) : null).filter(v=>v !== null && isFinite(v));
					if(popVals.length > 0 && populationSlider){
						const minPop = Math.max(0, Math.floor(Math.min(...popVals)));
						const maxPop = Math.max(minPop+1, Math.ceil(Math.max(...popVals)));
						populationSlider.updateOptions({
							range: {
								'min': minPop,
								'max': maxPop
							}
						});
						// clamp current values
						const currentValues = populationSlider.get();
						const clampedMin = Math.max(minPop, Math.min(maxPop, Number(currentValues[0])));
						const clampedMax = Math.max(minPop, Math.min(maxPop, Number(currentValues[1])));
						populationSlider.set([clampedMin, clampedMax]);
					}

					// build filtered list according to selected population range (if present)
					const popValues = populationSlider ? populationSlider.get() : [0, Number.POSITIVE_INFINITY];
					const minPobl = Number(popValues[0]);
					const maxPobl = Number(popValues[1]);
					const filteredMunicipios = municipios.filter(m => {
						if(!isFinite(m.poblacion)) return true; // keep those without population data
						return m.poblacion >= minPobl && m.poblacion <= maxPobl;
					});

					// After CSV loads (or fallback), update the mapLimit slider max to the filtered municipios count
					const slider = document.getElementById('mapLimitSlider');
					if(slider){
						const maxCount = filteredMunicipios && filteredMunicipios.length ? filteredMunicipios.length : 10;
						slider.max = Math.max(1, maxCount);
						// If current value is greater than max, clamp it
						if(Number(slider.value) > slider.max) slider.value = slider.max;
						const display = document.getElementById('mapLimitVal');
						if(display) display.textContent = slider.value;
					}

					// Compute scores on filtered list
					const weights = getSliderWeights();
					var sorted = computeScores(weights, filteredMunicipios);
				}catch(e){console.warn('Failed to update mapLimitSlider or population sliders', e);
					var weights = getSliderWeights();
					var sorted = computeScores(weights, municipios);
				}

				const showAll = document.getElementById('showAllMap')?.checked;
				let mapLimit = 0;
				if(showAll){
					mapLimit = sorted.length;
				} else {
					const slider = document.getElementById('mapLimitSlider');
					mapLimit = slider ? Number(slider.value) || 0 : Number(document.getElementById('mapLimit')?.value) || 0;
				}
				renderRanking(sorted, mapLimit);
			}catch(e){ console.warn('loadCSV failed, using fallback', e); loadFallback();
				// For fallback, do similar filtering if needed
				const minPobl = Number(document.getElementById('poblacion').value) || 0;
				const filteredMunicipios = municipios.filter(m =>
					isFinite(m.poblacion) && m.poblacion >= minPobl
				);
				const weights = getSliderWeights();
				const sorted = computeScores(weights, filteredMunicipios);
				renderRanking(sorted, 20);
			}

            // Cargar similares
            try{
                if(opts.forceReload) similaresLoaded = false;
                await loadSimilaresCSV();
            }catch(e){ console.warn('loadSimilaresCSV failed, skipping similares', e); }
        }
		
		// Helper para obtener imagen de Wikipedia 
		async function fetchWikiThumbnail(municipioName){
			if(!municipioName) return null;
			const title = municipioName.replace(/ /g, '_');
			const url = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
			try{
				const res = await fetch(url);
				if(!res.ok) return null;
				const data = await res.json();
				if(data && data.thumbnail && data.thumbnail.source) return data.thumbnail.source;
				// fallback: try English wiki
				const res2 = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`);
				if(res2.ok){
					const d2 = await res2.json();
					if(d2 && d2.thumbnail && d2.thumbnail.source) return d2.thumbnail.source;
				}
				return null;
			}catch(e){
				return null;
			}
		}

		// Geocodificaci√≥n OSM (Nominatim) - devuelve el primer resultado o null
		async function geocodeOSM(query){
			if(!query) return null;
			const base = 'https://nominatim.openstreetmap.org/search';
			const params = new URLSearchParams({format:'json', q: query, limit: '1', countrycodes: 'es', 'accept-language':'es'});
			const url = base + '?' + params.toString();
			try{
				const res = await fetch(url, {headers:{'Accept':'application/json'}});
				if(!res.ok) return null;
				const data = await res.json();
				if(data && data.length>0) return data[0];
			}catch(e){
				console.warn('Nominatim geocode error', e);
			}
			return null;
		}

		// Enrutamiento usando OSRM p√∫blico: devuelve true si dibuj√≥ ruta
		async function routeBetweenPoints(aLat,aLon,bLat,bLon){
			routeLayer.clearLayers();
			connectionLayer.clearLayers();
			if(!aLat || !aLon || !bLat || !bLon) return false;
			const url = `https://router.project-osrm.org/route/v1/driving/${aLon},${aLat};${bLon},${bLat}?overview=full&geometries=geojson&alternatives=false&steps=false`;
			try{
				const res = await fetch(url);
				if(!res.ok) throw new Error('OSRM no respondi√≥');
				const data = await res.json();
				if(data && data.routes && data.routes.length){
					const coords = data.routes[0].geometry.coordinates.map(c=>[c[1], c[0]]);
					const line = L.polyline(coords, {color:'#1e88e5', weight:4}).addTo(routeLayer);
						const dist = data.routes[0].distance || 0; // meters
						const dur = data.routes[0].duration || 0; // seconds
						// store last route info and update UI
						lastRouteInfo = {distance: dist, duration: dur, source: 'osrm'};
						updateDetailRoute();
						line.bindPopup(`Distancia: ${(dist/1000).toFixed(2)} km<br/>Duraci√≥n: ${Math.round(dur/60)} min`);
						// a√±adir etiqueta permanente sobre la ruta (en el centro aproximado)
						try{
							const coordsMid = coords[Math.floor(coords.length/2)];
							const labelText = `Ruta: ${(dist/1000).toFixed(2)} km ‚Äî ${Math.round(dur/60)} min`;
							line.bindTooltip(labelText, {permanent:true, direction:'center', className:'route-label', offset:[0,0]}).openTooltip(coordsMid);
						}catch(e){/* ignore */}
					return true;
				}
			}catch(e){
				console.warn('OSRM routing failed', e);
			}
			return false;
		}

		// Actualiza el panel de detalle con la informaci√≥n de ruta/linea si existe
		function updateDetailRoute(){
			const el = document.getElementById('detailRoute');
			if(!el) return;
			if(!lastRouteInfo){ el.textContent = ''; return; }
			if(lastRouteInfo.source === 'osrm'){
				const km = (lastRouteInfo.distance/1000).toFixed(2);
				const min = Math.round((lastRouteInfo.duration||0)/60);
				el.innerHTML = `<strong>Ruta (carretera)</strong>: ${km} km ‚Äî ${min} min`;
			} else if(lastRouteInfo.source === 'straight'){
				const km = (lastRouteInfo.distance/1000).toFixed(2);
				el.innerHTML = `<strong>L√≠nea recta</strong>: ${km} km`;
			} else {
				el.textContent = '';
			}
		}

		// Obtener y renderizar la lista de municipios similares
		async function updateSimilaresFromCSV(municipioBaseName){
			document.getElementById('similares-title').textContent = municipioBaseName ? "SIMILARES A " + municipioBaseName.toUpperCase() : "SIMILARES A MUNICIPIO QUE SE ELIGE";
			const simDiv = document.getElementById('similaresList');
			simDiv.innerHTML = '';

			if (!municipioBaseName) {
				simDiv.innerHTML = '<div class="muted" style="text-align:center;padding:12px;">Selecciona o busca un municipio para ver sus similares.</div>';
				return;
			}

			const maxSimilares = Number(document.getElementById('s-similares')?.value) || 5;
			const placeholderImg = 'assets/municipio-placeholder.jpg';

			// Buscar la fila de datos similares que coincida con el municipio base (case-insensitive)
			let simRow = null;
			if(Array.isArray(similaresData) && similaresData.length>0){
				const target = municipioBaseName.toString().trim().toLowerCase();
				simRow = similaresData.find(row => {
					const m = (row['municipio'] || row['Municipio'] || row['municipio_base'] || '').toString().trim().toLowerCase();
					return m && m === target;
				});
			}

			// If we have a simRow, use it. Otherwise fallback to top-N from the current ranking or the municipios list.
			if (simRow) {
				let municipiosSimilaresEncontrados = 0;
				for (let i = 1; i <= maxSimilares; i++) {
					const similarName = simRow[`sim${i}`] || simRow[`SIM${i}`] || simRow[`Sim${i}`];
					if (similarName) {
						// try case-insensitive lookup in municipioMap
						const s = municipioMap[similarName.toString().trim().toLowerCase()];
						if (s) {
							const d = document.createElement('div'); d.className='sim-card';
							const scoreTextTitle = isFinite(s.score) ? `Puntuaci√≥n: ${(s.score*100).toFixed(1)}` : 'Fuera del Ranking';
							d.title = `${s.name} - ${scoreTextTitle}`;
							const thumbDiv = document.createElement('div'); thumbDiv.className='thumb';
							thumbDiv.innerHTML = '<svg width="56" height="40" viewBox="0 0 56 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="56" height="40" rx="6" fill="#f3f4f6"/></svg>';
							d.appendChild(thumbDiv);
							const content = document.createElement('div'); content.style.flex='1';
							content.innerHTML = `<strong style="display:block">${s.name}</strong><div class="muted">Similar a ${municipioBaseName}</div>`;
							d.appendChild(content);
							d.onmouseenter = ()=>{
								if(currentRankMarkers[s.id]) { currentRankMarkers[s.id].openPopup(); }
								else if(s.lat && s.lon){
									const popupContent = isFinite(s.score) ? `<strong>${s.name}</strong><br/>Puntuaci√≥n: ${(s.score*100).toFixed(1)}` : `<strong>${s.name}</strong><br/>Fuera del Ranking`;
									const tempMarker = L.marker([s.lat,s.lon]).addTo(markerLayer).bindPopup(popupContent).openPopup();
									d._tempMarker = tempMarker;
								}
							};
							d.onmouseleave = ()=>{
								if(currentRankMarkers[s.id]) { currentRankMarkers[s.id].closePopup(); }
								else if(d._tempMarker){
									markerLayer.removeLayer(d._tempMarker);
									delete d._tempMarker;
								}
							};
							d.onclick = ()=> { if(s.lat && s.lon) map.setView([s.lat, s.lon], 12); selectRankingItem(s.name); }
							simDiv.appendChild(d);
							municipiosSimilaresEncontrados++;

							fetchWikiThumbnail(s.name).then(imgUrl=>{
								const img = document.createElement('img');
								img.alt = s.name;
								img.src = imgUrl || placeholderImg;
								img.onerror = () => { img.src = placeholderImg; };
								thumbDiv.innerHTML = '';
								thumbDiv.appendChild(img);
							}).catch(()=>{ thumbDiv.innerHTML = `<img src="${placeholderImg}" alt="${s.name}" onerror="this.src='${placeholderImg}'">`; });
						}
					}
				}
				if (municipiosSimilaresEncontrados === 0) {
					simDiv.innerHTML = `<div class="muted" style="text-align:center;padding:12px;">No hay municipios similares v√°lidos para **${municipioBaseName}**.</div>`;
				}
				return;
			}

			// Fallback: si no hay archivo de similares o no se encontr√≥ la fila, tomar top-N del ranking
			const candidates = Object.values(lastSortedMap).length ? Object.values(lastSortedMap) : municipios;
			if(!candidates || candidates.length===0){
				simDiv.innerHTML = `<div class="muted" style="text-align:center;padding:12px;">No hay datos disponibles para generar similares.</div>`;
				return;
			}

			let added = 0;
			const baseLower = municipioBaseName.toString().trim().toLowerCase();
			for(const item of candidates){
				if(added >= maxSimilares) break;
				if(!item || !item.name) continue;
				if(item.name.toString().trim().toLowerCase() === baseLower) continue; // skip the base itself
				const s = item;
				const d = document.createElement('div'); d.className='sim-card';
				const scoreTextTitle = isFinite(s.score) ? `Puntuaci√≥n: ${(s.score*100).toFixed(1)}` : 'Fuera del Ranking';
				d.title = `${s.name} - ${scoreTextTitle}`;
				const thumbDiv = document.createElement('div'); thumbDiv.className='thumb';
				thumbDiv.innerHTML = '<svg width="56" height="40" viewBox="0 0 56 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="56" height="40" rx="6" fill="#f3f4f6"/></svg>';
				d.appendChild(thumbDiv);
				const content = document.createElement('div'); content.style.flex='1';
				content.innerHTML = `<strong style="display:block">${s.name}</strong><div class="muted">Sugerido ‚Äî similar por ranking</div>`;
				d.appendChild(content);
				d.onmouseenter = ()=>{
					if(currentRankMarkers[s.id]) { currentRankMarkers[s.id].openPopup(); }
					else if(s.lat && s.lon){
						const popupContent = isFinite(s.score) ? `<strong>${s.name}</strong><br/>Puntuaci√≥n: ${(s.score*100).toFixed(1)}` : `<strong>${s.name}</strong><br/>Fuera del Ranking`;
						const tempMarker = L.marker([s.lat,s.lon]).addTo(markerLayer).bindPopup(popupContent).openPopup();
						d._tempMarker = tempMarker;
					}
				};
				d.onmouseleave = ()=>{
					if(currentRankMarkers[s.id]) { currentRankMarkers[s.id].closePopup(); }
					else if(d._tempMarker){
						markerLayer.removeLayer(d._tempMarker);
						delete d._tempMarker;
					}
				};
				d.onclick = ()=> { selectRankingItem(s.id || s.name); }
				simDiv.appendChild(d);

				fetchWikiThumbnail(s.name).then(imgUrl=>{
					const img = document.createElement('img');
					img.alt = s.name;
					img.src = imgUrl || placeholderImg;
					img.onerror = () => { img.src = placeholderImg; };
					thumbDiv.innerHTML = '';
					thumbDiv.appendChild(img);
				}).catch(()=>{ thumbDiv.innerHTML = `<img src="${placeholderImg}" alt="${s.name}" onerror="this.src='${placeholderImg}'">`; });

				added++;
			}

			if(added === 0){
				simDiv.innerHTML = `<div class="muted" style="text-align:center;padding:12px;">No se encontraron similares (ni CSV ni ranking disponible).</div>`;
			}
		}

		// attach slider display update and re-run search 
		const sliderIds = {educ:'s-educ',sani:'s-sani',ocio:'s-ocio',cost:'s-cost',serv:'s-serv',mov:'s-mov',econ:'s-econ'};
        Object.keys(sliderIds).forEach(key=>{
            const el = document.getElementById(sliderIds[key]);
            const disp = document.getElementById('val-'+(key));
            el.addEventListener('input', ()=>{ disp.textContent = el.value; });
            el.addEventListener('change', ()=>{ runSearch({forceReload:false}); });
        });
        
        // Slider para similares
        const similaresSlider = document.getElementById('s-similares');
        const similaresDisp = document.getElementById('val-similares');
        similaresSlider.addEventListener('input', ()=>{ similaresDisp.textContent = similaresSlider.value; });

		// Population range sliders wiring (min / max) with noUiSlider
		(function(){
			const sliderEl = document.getElementById('population-slider');
			const minDisplay = document.getElementById('popMinVal');
			const maxDisplay = document.getElementById('popMaxVal');
			function updateDisplays(values){
				if(minDisplay) minDisplay.textContent = Number(values[0]).toLocaleString('es-ES');
				if(maxDisplay) maxDisplay.textContent = Number(values[1]).toLocaleString('es-ES');
			}
			if(sliderEl && typeof noUiSlider !== 'undefined'){
				populationSlider = noUiSlider.create(sliderEl, {
					start: [0, 100000],
					connect: true,
					range: {
						'min': 0,
						'max': 100000
					},
					step: 1000,
					tooltips: false,
					format: {
						to: function (value) {
							return Math.round(value);
						},
						from: function (value) {
							return Number(value);
						}
					}
				});
				populationSlider.on('update', function (values, handle) {
					updateDisplays(values);
				});
				populationSlider.on('change', function (values, handle) {
					runSearch({forceReload:false});
				});
			}
		})();

		// basic search box filter for the displayed ranking
		document.getElementById('mainSearch').addEventListener('input', (e)=>{
			const qRaw = e.target.value.toLowerCase();
			const q = qRaw.replace(/\s+/g,''); // normalize: remove spaces so searches with spaces match
			document.querySelectorAll('.ranking-item').forEach(item=>{
				const name = item.textContent.split('(')[0].replace(/[#\d\s]/g,'').toLowerCase(); // name filter logic
				const nameNorm = name.replace(/\s+/g,'');
				item.style.display = q ? (nameNorm.includes(q) ? 'block' : 'none') : 'block';
			});
		});

		// Modal functions for info
		function showInfoModal() {
			const p = document.getElementById('infoModal').querySelector('p');
			p.innerHTML = explanation;
			document.getElementById('infoModal').style.display = 'flex';
		}
		function hideInfoModal() {
			document.getElementById('infoModal').style.display = 'none';
		}

		// Modal functions for help
		function showHelpModal() {
			const p = document.getElementById('helpModal').querySelector('p');
			p.innerHTML = `
			<h3>ü§î Sobre esta plataforma</h3>
			Descubre tu pr√≥ximo municipio en la Comunidad de Madrid con datos y recomendaciones personalizadas. Nuestra plataforma est√° dise√±ada para ayudarte a tomar una decisi√≥n informada si est√°s pensando en mudarte de la capital a un municipio peque√±o (menos de 50.000 habitantes).
			<br><br>
			üîé <strong>¬øC√≥mo funciona?</strong>
			<br>
			Analizamos accesibilidad y distancia a los principales servicios p√∫blicos.
			<br>
			Evaluamos la disponibilidad de recursos esenciales como sanidad, educaci√≥n, transporte y ocio.
			<br>
			Incorporamos tus preferencias personales para recomendarte el municipio que mejor se adapta a tu estilo de vida.
			<br><br>
			üìä <strong>Basado en datos reales</strong>
			<br>
			La herramienta combina informaci√≥n oficial y criterios ciudadanos para que tu calidad de vida no se vea afectada al cambiar de entorno.
			<br><br>
			‚ú® <strong>Tu decisi√≥n, con respaldo objetivo</strong>
			<br>
			No se trata solo de mudarse, sino de elegir un lugar donde vivir mejor. Nuestra web te ofrece un sistema de recomendaci√≥n multicriterio que convierte tus prioridades en resultados claros y comparables.`;
			document.getElementById('helpModal').style.display = 'flex';
		}
		function hideHelpModal() {
			document.getElementById('helpModal').style.display = 'none';
		}

		// place input: center map on typed municipality; use CSV match or fallback to OSM (Nominatim)
		document.getElementById('placeInput').addEventListener('change', async (e)=>{
			const qRaw = (e.target.value || '').trim();
			const q = qRaw.toLowerCase();
			if(!q){ interestLayer.clearLayers(); connectionLayer.clearLayers(); routeLayer.clearLayers(); lastRouteInfo = null; updateDetailRoute(); return; }

			// try exact lookup in municipioMap (lowercase keys), then fallback to substring search
			let found = municipioMap[q] || municipios.find(m=>m.name && m.name.toLowerCase().includes(q));

			// If nothing found and CSV not loaded, try forcing CSV load (maybe user typed early)
			if(!found && !csvLoaded){
				try{ await runSearch({forceReload:true}); }catch(err){ console.warn('force reload in placeInput failed', err); }
				found = municipioMap[q] || municipios.find(m=>m.name && m.name.toLowerCase().includes(q));
			}

			if(found){
				showDetail(found);
				updateSimilaresFromCSV(found.name);
				if(found.lat && found.lon){
					// create/update red interest marker
					interestLayer.clearLayers();
					const redHtml = `<div style="background:#dc3545;color:#fff;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.25)">‚Ä¢</div>`;
					const icon = L.divIcon({className:'interest-icon', html:redHtml, iconSize:[26,26], iconAnchor:[13,13]});
					const mkr = L.marker([found.lat, found.lon], {icon}).bindPopup(`<strong>Lugar de inter√©s</strong><br/>${found.name}`);
					mkr.addTo(interestLayer);
					mkr.openPopup();
					map.setView([found.lat, found.lon], 12);
					// Dibujar conexi√≥n si hay un municipio seleccionado
					try{ const sel = document.querySelector('.ranking-item.selected'); if(sel){ const id = parseInt(sel.id.split('-')[2]); const selM = lastSortedMap[id] || municipios.find(x=>x.id===id); if(selM) drawConnectionBetween(selM, mkr.getLatLng()); } }catch(e){console.warn('connect after interest (csv) failed', e);} 
				} else {
					alert('Ubicaci√≥n encontrada pero no tiene coordenadas para mostrar en el mapa.');
				}
								// Dibujar conexi√≥n si hay un municipio seleccionado
								try{ const sel = document.querySelector('.ranking-item.selected'); if(sel){ const id = parseInt(sel.id.split('-')[2]); const selM = lastSortedMap[id] || municipios.find(x=>x.id===id); if(selM) drawConnectionBetween(selM, mkr.getLatLng()); } }catch(e){console.warn('connect after interest (osm) failed', e);} 
			} else {
				// If not found in CSV, try geocoding against OSM/Nominatim
				const osm = await geocodeOSM(qRaw);
				if(osm && osm.lat && osm.lon){
					const temp = { id: 'osm-'+Date.now(), name: osm.display_name || qRaw, lat: Number(osm.lat), lon: Number(osm.lon), desc: 'Resultado geocodificado desde OpenStreetMap (Nominatim).', isExternal: true };
					// Show detail but don't try to fetch similares (not in CSV)
					showDetail(temp);
					document.getElementById('similaresList').innerHTML = `<div class="muted" style="text-align:center;padding:12px;">Ubicaci√≥n geocodificada desde OSM: no est√° en el CSV.</div>`;

					// create/update red interest marker
					interestLayer.clearLayers();
					const redHtml = `<div style="background:#dc3545;color:#fff;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.25)">‚Ä¢</div>`;
					const icon = L.divIcon({className:'interest-icon', html:redHtml, iconSize:[26,26], iconAnchor:[13,13]});
					const mkr = L.marker([temp.lat, temp.lon], {icon}).bindPopup(`<strong>Lugar de inter√©s (OSM)</strong><br/>${temp.name}`);
					mkr.addTo(interestLayer);
					mkr.openPopup();
					map.setView([temp.lat, temp.lon], 12);
					// Dibujar conexi√≥n si hay un municipio seleccionado
					try{ const sel = document.querySelector('.ranking-item.selected'); if(sel){ const id = parseInt(sel.id.split('-')[2]); const selM = lastSortedMap[id] || municipios.find(x=>x.id===id); if(selM) drawConnectionBetween(selM, mkr.getLatLng()); } }catch(e){console.warn('connect after interest (osm) failed', e);} 
				} else {
					alert('No se encontr√≥ ning√∫n municipio que coincida con: ' + (qRaw||''));
				}
			}
		});

		// initial load
		// Chatbot implementation (front-end demo with optional real API call)
		function renderChatMessage(role, text){
			const container = document.getElementById('chatMessages');
			const wrap = document.createElement('div');
			wrap.className = 'message ' + (role === 'user' ? 'user' : 'assistant');
			const bubble = document.createElement('div');
			bubble.className = 'bubble';
			bubble.textContent = text;
			wrap.appendChild(bubble);
			container.appendChild(wrap);
			container.scrollTop = container.scrollHeight;
		}

		async function callOpenRouterAPI(messages, apiKey){
			const url = "https://openrouter.ai/api/v1/chat/completions";
			const headers = {
				"Authorization": `Bearer ${apiKey || 'DUMMY'}`,
				"Content-Type": "application/json"
			};
			const payload = {
				model: "deepseek/deepseek-chat-v3.1",
				messages: messages
			};
			try{
				const res = await fetch(url, {method:'POST', headers, body: JSON.stringify(payload)});
				if(!res.ok) throw new Error('Network response not ok');
				const data = await res.json();
				// Try to extract a sensible assistant message from response (demo - may vary by API)
				if(data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content){
					return data.choices[0].message.content;
				}
				if(data && data.output && data.output[0] && data.output[0].content) return data.output[0].content;
				return JSON.stringify(data);
			}catch(err){
				console.warn('OpenRouter API call failed, falling back to dummy. Error:', err);
				throw err;
			}
		}

		function simulateAssistantReply(userText){
			// Very simple demo responses; can be enhanced.
			const u = userText.toLowerCase();
			if(u.includes('ruta') || u.includes('distancia')) return 'Puedo estimar la distancia y ruta entre municipios si seleccionas un punto de inter√©s.';
			if(u.includes('educ') || u.includes('escuela')) return 'La educaci√≥n es uno de los factores que ponderamos. Ajusta el slider para priorizarla.';
			return 'Esto es una respuesta demo. (API real no configurada o CORS bloque√≥ la llamada).';
		}

		// API key loaded from `secrets.js` on the client. If not present, EMBEDDED_API_KEY will be null.
		// Note: keeping secrets in a client-side file is still not secure for production. Prefer a server-side proxy.
		const EMBEDDED_API_KEY = (window && window.SECRETS && window.SECRETS.OPENROUTER_API_KEY) ? window.SECRETS.OPENROUTER_API_KEY : null;
		// Dummy mode disabled by default when control buttons are removed
		const USE_DUMMY = false;
		async function sendChatMessage(){
			const ta = document.getElementById('chatInput');
			const text = (ta.value || '').trim();
			if(!text) return;
			renderChatMessage('user', text);
			ta.value = '';
			const apiKey = EMBEDDED_API_KEY;
			const useDummy = USE_DUMMY;
			renderChatMessage('assistant', '...');
			// remove the last assistant placeholder when actual reply arrives
			const container = document.getElementById('chatMessages');
			const lastPlaceholder = container.querySelector('.message.assistant:last-child .bubble');
			try{
				let reply;
				if(!useDummy){
					// A√±adir el mensaje del usuario al historial de conversaci√≥n
					conversationHistory.push({role: 'user', content: text});
					// Construir el array de mensajes con el prompt del sistema y el historial completo
					const messages = [
						{role:'system',
						content: 'Eres un asistente que ayuda a encontrar municipios, procura ser √∫til y conciso pero humano.'+
								' Respondes solo preguntas relacionadas con municipios de la Comunidad de Madrid.'+
								' Si no sabes la respuesta, di que no lo sabes. Tus respuestas deben ser en espa√±ol.'+
								' Tienes que devolver texto plano, sin italicas, negritas, ni formato especial.' +
								' Tienes que responder en el idioma de la pregunta.' +
								' Informaci√≥n de contexto sobre los √≠ndices: ' + explanation.replace(/<[^>]*>?/gm, ' ')
							},
						// Incluir el historial de conversaci√≥n para mantener la memoria
						...conversationHistory
					];
					reply = await callOpenRouterAPI(messages, apiKey);
				} else {
					// Dummy response
					reply = simulateAssistantReply(text);
				}
				if(lastPlaceholder) lastPlaceholder.textContent = reply;
				// A√±adir la respuesta del asistente al historial de conversaci√≥n
				conversationHistory.push({role: 'assistant', content: reply});
			}catch(err){
				const fallback = simulateAssistantReply(text);
				if(lastPlaceholder) lastPlaceholder.textContent = fallback;
				// Incluir tambi√©n las respuestas de fallback en el historial
				conversationHistory.push({role: 'assistant', content: fallback});
			}
		}

		// Initial assistant welcome message
		renderChatMessage('assistant', 'Hola, soy tu Asistente IA para ayudarte a saber m√°s sobre los municipios. Preg√∫ntame cualquier duda que tengas sobre ello.');

		document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
		document.getElementById('chatInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChatMessage(); } });

		// initial load
		runSearch({forceReload:true}).catch(err=>{ console.warn('Initial runSearch failed, falling back', err); loadFallback(); renderRanking(municipios,20); });
	</script>
</body>
</html>
