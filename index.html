<!doctype html>
<html lang="es">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Búsqueda de Municipios - Madrid</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="" crossorigin=""></script>
	<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

	<style>
		/* --- ESTILOS CONSOLIDADOS --- */
		:root{
			--bg: #dcfcf3; 			/* azul crema*/
			--card: #c0ebe6;
			--accent: #011b30; 		/* color dominante oscuro */
			--accent-strong: #033d4a; /* color de acento para ranking/marcadores */
			--muted: #19191c;
			--separator: rgba(31,78,121,0.08);
			--gap: 12px;
		}
        
	    /* body + layout tweaks (from original, enhanced with theme) */
		html,body{height:100vh;width:100vw;margin:0;padding:0;box-sizing:border-box;overflow:hidden;font-family:Inter,Segoe UI,Arial;color:#0f1724;background:var(--bg)}
		.app{display:flex;flex-direction:column;height:100vh}
				
		/* Título más grande y con buscador flotante */
		header{position:relative; display:flex;align-items:center;justify-content:center;padding:32px;background:var(--bg);border-bottom:none;}
		header h1{margin:0;font-size:58px; color:var(--accent);font-weight:800; letter-spacing:0.8px;}
				
		.topbar-search{position:absolute; right:55px; top:50%; transform:translateY(-50%); width:320px}
		.search-input{width:100%;padding:14px 16px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);box-shadow:0 1px 2px rgba(16,24,40,.03);font-size:16px}

		/* Grid Layout */
		.container{flex:1;display:grid;grid-template-columns:280px 1fr 395px;grid-template-rows:1fr 315px;gap:var(--gap);padding:18px;min-height:0}
		.left{grid-column:1/2;grid-row:1/2;padding:12px;overflow:auto;}
		.center{grid-column:2/3;grid-row:1/2;background:var(--card);border-radius:10px;padding:8px;display:flex;flex-direction:column;min-height:0;border:1px solid var(--separator);box-shadow:0 2px 5px rgba(16,24,40,.03)}
		.right{grid-column:3/4;grid-row:1/2;background:var(--card);padding:12px;border-radius:10px;overflow:auto;border:1px solid var(--separator);box-shadow:0 2px 5px rgba(16,24,40,.03)}
						
		/* Fila inferior de 3 columnas (Ranking, Detalle, Chatbot) */
		.bottom{grid-column:1/4;grid-row:2/3;display:grid;grid-template-columns:1fr 1fr 1fr; gap:12px;min-height:0}

		/* Cards y Contenido Scrolleable */
		.bottom .card{height:100%;display:flex;flex-direction:column;overflow:hidden;}
		.card{background:var(--card);border-radius:10px;padding:10px;margin-bottom:10px;box-shadow:0 2px 5px rgba(16,24,40,.03); border:1px solid var(--separator);}
						
		.ranking-list-content, .detail-content{
			padding:0 12px 12px 12px; /* Ajuste para scroll */
			flex:1;
			overflow-y:auto; 
		}
						
		#map{height:100%;border-radius:8px}

		/* SIMILARES card look */
		.sim-card{
			display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);
			background:linear-gradient(180deg,rgba(255,255,255,0.7),rgba(255,255,255,0.9));
			cursor: pointer;
		}
		.sim-card:hover{background:linear-gradient(180deg,rgba(250,250,250,0.8),rgba(255,255,255,0.95));}
		.sim-card .thumb{
			width:56px;height:40px;border-radius:6px;background:#f3f4f6;overflow:hidden;flex:0 0 56px;display:flex;align-items:center;justify-content:center;
		}
		.sim-card .thumb img{width:100%;height:100%;object-fit:cover;display:block;transition:opacity 0.3s}

		/* Slider look and feel */
		.sliders label{display:flex;justify-content:space-between;font-size:13px;margin-top:10px;color:var(--muted)}
	    input[type=range]{-webkit-appearance:none;width:100%;height:8px;border-radius:6px;background:linear-gradient(90deg,var(--accent-strong),#a8c7f0);outline:none}
		input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);box-shadow:0 2px 6px rgba(31,78,121,0.18);border:2px solid #fff;margin-top:-5px}
		input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--accent);border:2px solid #fff}

		.sep{height:1px;background:var(--separator);margin:12px 0;border-radius:1px}

		/* Sponsor slider animation/positioning */
		.sponsor-rotator{
			position:fixed;
			left:19px; 	
			top:19px; 	
			width:365px; 
			height:81px; 
			overflow-x:hidden; 
			overflow-y:hidden;
			z-index:1000;
			background:transparent; 
			pointer-events:auto;
		}

		.sponsor-track{
			display:flex;
			align-items:center;
			gap:25px;
			padding:0;
			box-sizing:border-box;
			flex-wrap:nowrap;
			min-width: max-content;
			animation:slide-left 9s linear infinite; 
		}

		.sponsor-track img{
			height:81px; 	
			width:auto;
			display:inline-block;
			object-fit:contain;
			opacity:1;
			transition:transform .25s ease, opacity .25s ease;
			flex:0 0 auto;
		}

		@keyframes slide-left{
			0%   { transform:translateX(0); }
			100% { transform:translateX(-50%); } 
		}

		/* Mobile adjustments */
		@media (max-width:900px){
			.container{grid-template-columns:1fr;grid-template-rows:minmax(0, 1fr) 1fr 320px 360px; }
			.left{grid-column:1/2;grid-row:3/4; height: 320px;} 
			.right{grid-column:1/2;grid-row:2/3} 
			.center{grid-column:1/2;grid-row:1/2} 
			.bottom{grid-row:4/5;grid-column:1/2;grid-template-columns:1fr;} 
			
			header {
				flex-direction: column; 
				align-items: flex-start;
				padding: 10px 18px 18px 18px; 
				min-height: 100px;
			}
			header h1 {
				font-size: 24px;
				order: 2; 
				margin-top: 12px;
			}
			.topbar-search{
				position: static; 
				width: 100%;
				margin-top: 10px;
				order: 3; 
				transform: none; 
			}

			.sponsor-rotator{
				position: static; 
				width: 100%;
				height: 56px;
				left: auto;
				top: auto;
				overflow-x: auto; 
				order: 1; 
			}
			.sponsor-track{
				animation: none; 
				gap: 16px;
				padding: 0 0 0 4px;
			}
			.sponsor-track img{
				height: 48px; 
			}
		}

		.ranking-item{padding:8px;border-bottom:1px dashed var(--separator);cursor:pointer}
		.ranking-item:hover{background:#fcfdfe}
		.muted{color:var(--muted);font-size:13px}
		.ranking-item.selected{background:linear-gradient(90deg,var(--separator),#fcfdfe);border-left:4px solid var(--accent-strong);}
		
	</style>
</head>
<body>
	<div class="app">
		
		<div class="sponsor-rotator" id="sponsorRot">
			<div class="sponsor-track" id="sponsorTrack">
				<img src="logos/logo1.png" alt="Patrocinador 1">
				<img src="logos/logo2.png" alt="Patrocinador 2">
				<img src="logos/logo3.png" alt="Patrocinador 3">
				<img src="logos/logo1.png" alt="Patrocinador 1">
				<img src="logos/logo2.png" alt="Patrocinador 2">
				<img src="logos/logo3.png" alt="Patrocinador 3">
			</div>
		</div>

		<header>
			<h1>Búsqueda de tu municipio ideal</h1>
			<div class="topbar-search">
				<input class="search-input" id="mainSearch" placeholder="Búsqueda de municipios ➤ " />
			</div>
		</header>

		<main class="container">
			<aside class="left card">
				<h3>SIMILARES</h3>
				<label>Número de similares a mostrar: <span id="val-similares">5</span></label>
                <input type="range" id="s-similares" min="1" max="5" value="5" />
                <hr class="sep" />
                <div id="similaresList" class="ranking-list-content"> 
                    </div>
			</aside>

			<section class="center"> 
				<div style="flex:1;min-height:0">
					<div id="map" style="height:100%"></div>
				</div>
			</section>

			<aside class="right"> 
				<h3>¿CUÁNTO VALORAS...?</h3>
				<div class="sliders">
					<label>Educación <span id="val-educ">5</span></label>
					<input type="range" id="s-educ" min="0" max="10" value="5" />

					<label>Sanidad <span id="val-sani">5</span></label>
					<input type="range" id="s-sani" min="0" max="10" value="5" />

					<label>Ocio y cultura <span id="val-ocio">5</span></label>
					<input type="range" id="s-ocio" min="0" max="10" value="5" />

					<label>Bienestar y servicios <span id="val-cost">5</span></label>
					<input type="range" id="s-cost" min="0" max="10" value="5" />

					<label>Movilidad <span id="val-mov">5</span></label>
					<input type="range" id="s-mov" min="0" max="10" value="5" />

					<label>Economía y empleo <span id="val-econ">5</span></label>
					<input type="range" id="s-econ" min="0" max="10" value="5" />
				</div>

				<hr class="sep" />
				<h4>Lugar de Interés</h4>
				<input id="placeInput" placeholder="Introduce una ubicación que visitas frecuentemente" style="width:100%;padding:10px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);margin-bottom:12px" />
				
				<button id="buscarBtn" style="width:100%;padding:10px 12px;background:var(--accent);color:#fff;border:none;border-radius:6px;">Buscar</button>

				<div style="margin-top:12px;margin-bottom:8px">
					<input type="checkbox" id="colorZones" checked>
					<label for="colorZones" style="margin-left:6px;margin-top:0">Colorear zonas (aprox.)</label>
				</div>

				<div style="margin-top:8px;display:flex;align-items:center;margin-bottom:8px">
					<label style="margin-right:8px;color:var(--muted);margin-top:0">Mostrar en mapa:</label>
					<input type="number" id="mapLimit" min="0" max="200" value="10" style="width:72px;padding:6px;border-radius:6px;border:1px solid var(--separator)">
				</div>
				
				<div style="margin-top:6px">
					<input type="checkbox" id="showAllMap">
					<label for="showAllMap" style="margin-left:6px;margin-top:0">Mostrar todas en mapa</label>
				</div>
			</aside>

			<section class="bottom">
				<div class="card"> 
					<h3 style="padding:0 12px">Ranking</h3>
					<div id="ranking" class="ranking-list-content"></div> 
				</div>
				
				<div class="card"> 
					<h3 id="detailTitle" style="padding:0 12px">Selecciona un municipio</h3>
					<div id="detailContent" class="detail-content"> 
						<div id="detailProfile" class="muted">Datos: Educación, Sanidad, Ocio, Bienestar y servicios, Movilidad</div>
						<h4>BREVE DESCRIPCIÓN DEL MUNICIPIO</h4>
						<p id="detailDesc">Aquí aparecerá una pequeña descripción cuando selecciones un municipio del ranking.</p>
					</div>
				</div>
				
				<div class="card" id="chatbot-placeholder">
					<h3 style="padding:0 12px">ChatBot Asistente</h3>
					<div style="padding:12px; flex:1; display:flex; align-items:center; justify-content:center; color:var(--muted); border-top:1px solid var(--separator); margin-top:10px;">
						Próximamente...
					</div>
				</div>
				
			</section>
		</main>
	</div>

	<script>
		// app state
		let municipios = []; 
		let similaresData = []; // Para almacenar los datos de municipios_similares.csv
		const markers = {};

		// Map setup (Leaflet already included)
		const map = L.map('map', {zoomControl:true}).setView([40.4168,-3.7038],10);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);

		const markerLayer = L.layerGroup().addTo(map);
		let currentRankMarkers = {}; 
		let lastSortedMap = {}; 
		const areaLayer = L.layerGroup().addTo(map);
		let municipioMap = {}; // Mapa para acceder rápidamente a un municipio por nombre

		// Funcionalidad del botón Buscar (ahora en el HTML)
		const buscarBtn = document.getElementById('buscarBtn');
		buscarBtn.onclick = async ()=>{
			try{
				buscarBtn.disabled = true;
				buscarBtn.textContent = 'Buscando...';
				await runSearch({forceReload:true});
			}catch(e){
				console.error('Error en buscar:', e);
				alert('Error al buscar. Mira la consola para más detalles.');
			}finally{
				buscarBtn.disabled = false;
				buscarBtn.textContent = 'Buscar';
			}
		};

		// Auto-run search when map options change (checkbox/number)
		document.querySelectorAll('.right input[type="checkbox"], .right input[type="number"]').forEach(input=>{
			input.addEventListener('change', ()=>{
				try{ runSearch({forceReload:false}); }catch(e){ console.error('runSearch error from change', e); }
			});
		});

		// Auto-run search when similares slider changes
        document.getElementById('s-similares').addEventListener('change', ()=>{
            // Llamar a la función de similares con el municipio seleccionado o el rank 1
            const currentSelected = document.querySelector('.ranking-item.selected');
            if (currentSelected) {
                const id = parseInt(currentSelected.id.split('-')[2]);
                const m = lastSortedMap[id] || municipios.find(x=>x.id===id);
                if (m) {
                    updateSimilaresFromCSV(m.name);
                    return;
                }
            }
			// Fallback: usar el rank 1
            if (lastSortedMap && Object.keys(lastSortedMap).length > 0) {
                 const rank1 = Object.values(lastSortedMap).sort((a,b)=>b.score - a.score)[0];
                 if(rank1) updateSimilaresFromCSV(rank1.name);
            } else {
                 updateSimilaresFromCSV(null); // Borrar la lista si no hay ranking
            }
        });

		// mapping of slider keys to CSV columns 
		const columnMap = { educ:'educacion', sani:'sanidad', ocio:'ocio_cultura', cost:'bienestar', mov:'transporte_conectividad', econ:'economia_empleo' };

		// load CSV 
		let csvLoaded = false;
		function loadCSV(){
			return new Promise((resolve, reject)=>{
				if(csvLoaded) return resolve();
				Papa.parse('df_indices_categorias.csv', {
					download: true,
					header: true,
					dynamicTyping: true,
					skipEmptyLines: true,
					complete: function(results){
						municipios = results.data.map((r, i)=>({
							id: i+1,
							cod: r.cod_municipio,
							name: r.municipio || r.nombre || `Municipio ${i+1}`,
							lat: Number(r.latitud) || Number(r.latitude) || null,
							lon: Number(r.longitud) || Number(r.longitude) || null,
							alt: Number(r.altitud) || null,
							sanidad: Number(r.sanidad) || 0,
							educacion: Number(r.educacion) || 0,
							transporte_conectividad: Number(r.transporte_conectividad) || 0,
							economia_empleo: Number(r.economia_empleo) || 0,
							bienestar: Number(r.bienestar) || 0,
							ocio_cultura: Number(r.ocio_cultura) || 0,
							desc: r.descripcion || r.Descripcion || r.description || r.Description || ''
						}));
						csvLoaded = true;
                        municipioMap = {}; // Reset map
                        municipios.forEach(m=>{
                            municipioMap[m.name] = m; // Llenar el mapa
                        });
                        resolve();
					},
					error: function(err){
						console.error('CSV load error', err);
						reject(err);
					}
				});
			});
		}

		// NUEVA: Cargar CSV de Similares
        let similaresLoaded = false;
        function loadSimilaresCSV(){
            return new Promise((resolve, reject)=>{
                if(similaresLoaded) return resolve();
                Papa.parse('municipios_similares.csv', {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results){
                        similaresData = results.data;
                        similaresLoaded = true;
                        resolve();
                    },
                    error: function(err){
                        console.error('Similares CSV load error', err);
                        // Fallback: usar los primeros 3 municipios del ranking como antes
                        similaresData = []; 
                        reject(err);
                    }
                });
            });
        }

		// fallback mock 
		function loadFallback(){
			municipios = [
				{id:1,name:'Alcalá de Henares',lat:40.481,lon:-3.363,educacion:8, sanidad:7, ocio_cultura:8, bienestar:6, transporte_conectividad:7, economia_empleo:7, desc:'Ciudad universitaria y con buena oferta cultural.'},
				{id:2,name:'Majadahonda',lat:40.453,lon:-3.873,educacion:7, sanidad:8, ocio_cultura:6, bienestar:6, transporte_conectividad:8, economia_empleo:6, desc:'Municipio residencial con buen acceso a Madrid.'},
				{id:3,name:'Getafe',lat:40.308,lon:-3.732,educacion:6, sanidad:6, ocio_cultura:7, bienestar:6, transporte_conectividad:7, economia_empleo:8, desc:'Ciudad con gran actividad industrial y universitaria.'}
			];
			municipioMap = {};
            municipios.forEach(m=>{ municipioMap[m.name] = m; });
            csvLoaded = false;
		}

		// compute scores 
		function computeScores(weights){
			const scored = municipios.map(m=>{
				let s = 0;
				Object.keys(columnMap).forEach(k=>{
					const col = columnMap[k];
					const w = weights[k] || 0;
					const v = isFinite(m[col])? m[col] : 0; 
					s += w * v;
				});
				return {...m, score: s };
			});
			return scored.sort((a,b)=>b.score - a.score);
		}

		// create numbered marker 
		function createNumberedMarker(m, rank){
			const numberHtml = `<div style="background:${rank===1?'#ffc107':'#2b7be4'};color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid #fff;box-shadow:0 1px 2px rgba(0,0,0,.2)">${rank}</div>`;
			const icon = L.divIcon({className:'number-icon', html:numberHtml, iconSize:[30,30], iconAnchor:[15,30]});
			const marker = L.marker([m.lat,m.lon], {icon}).bindPopup(`<strong>#${rank} ${m.name}</strong><br/>Puntuación: ${(m.score*100).toFixed(1)}`);
			return marker;
		}

		// map score to color 
		function scoreToColor(score){
			const s = Math.max(0, Math.min(1, score));
			function lerpColor(a,b,t){
				return [
					Math.round(a[0] + (b[0]-a[0])*t),
					Math.round(a[1] + (b[1]-a[1])*t),
					Math.round(a[2] + (b[2]-a[2])*t)
				];
			}
			const red = [220,53,69]; 
			const yellow = [255,215,0];
			const green = [34,139,34]; 
			let rgb;
			if(s < 0.5){
				const t = s / 0.5;
				rgb = lerpColor(red, yellow, t);
			} else {
				const t = (s - 0.5) / 0.5;
				rgb = lerpColor(yellow, green, t);
			}
			return `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
		}

		// display names 
		const displayNames = {
			'educacion': 'Educación',
			'sanidad': 'Sanidad',
			'ocio_cultura': 'Ocio y cultura',
			'bienestar': 'Bienestar y servicios',
			'transporte_conectividad': 'Transporte y conectividad',
			'economia_empleo': 'Economía y empleo'
		};

		// render ranking 
		function renderRanking(sorted, mapLimit=20){
            const list = document.getElementById('ranking');
            list.innerHTML = '';

            markerLayer.clearLayers();
            currentRankMarkers = {};
            areaLayer.clearLayers();
            lastSortedMap = {};

            sorted.forEach((m, idx)=>{
                lastSortedMap[m.id] = m;
                const rank = idx+1;
                const div = document.createElement('div');
                div.className = 'ranking-item';
                div.id = 'ranking-item-' + m.id;
                const scoreText = isFinite(m.score)? `(Puntuación: ${(m.score*100).toFixed(1)})` : '';
                div.innerHTML = `<strong>#${rank} ${m.name}</strong> <div class="muted">${scoreText}</div>`;
                div.onclick = ()=> { 
                    selectRankingItem(m.id); 
                    updateSimilaresFromCSV(m.name); // NUEVO: Actualizar similares al hacer clic
                };
                div.onmouseenter = ()=> { if(currentRankMarkers[m.id]) currentRankMarkers[m.id].openPopup(); };
                div.onmouseleave = ()=> { if(currentRankMarkers[m.id]) currentRankMarkers[m.id].closePopup(); };
                list.appendChild(div);

                if(idx < mapLimit && m.lat && m.lon){
                    const mrk = createNumberedMarker(m, rank);
                    mrk.addTo(markerLayer);
                    mrk.on('click', ()=> {
                        selectRankingItem(m.id);
                        updateSimilaresFromCSV(m.name); // NUEVO: Actualizar similares al hacer clic en marcador
                    });
                    currentRankMarkers[m.id] = mrk;
                    const enableColor = document.getElementById('colorZones')?.checked;
                    if(enableColor){
                        const radius = 1250;
                        const c = L.circle([m.lat,m.lon], {radius: radius, color: scoreToColor(m.score), fillColor: scoreToColor(m.score), fillOpacity: 0.25, weight:1}).bindPopup(`<strong>#${rank} ${m.name}</strong><br/>Puntuación: ${(m.score*100).toFixed(1)}`);
                        c.addTo(areaLayer);
                        c.on('click', ()=> {
                             selectRankingItem(m.id);
                             updateSimilaresFromCSV(m.name); // NUEVO: Actualizar similares al hacer clic en zona
                        });
                    }
                }
            });

			// Mostrar similares para el Rank 1 por defecto
            if (sorted.length > 0) {
                updateSimilaresFromCSV(sorted[0].name); 
                selectRankingItem(sorted[0].id); // Seleccionar el rank 1 por defecto
            } else {
                updateSimilaresFromCSV(null);
            }
        }

		// show detail 
		function showDetail(m){
            document.getElementById('detailTitle').textContent = m.name;
            const parts = [];
            ['educacion','sanidad','ocio_cultura','bienestar','transporte_conectividad','economia_empleo'].forEach(col=>{
                if(col in m){
                    const label = displayNames[col] || col.replace('_',' ');
                    parts.push(`${label}: ${isFinite(m[col])?m[col].toFixed(2):'—'}`);
                }
            });
            document.getElementById('detailProfile').textContent = 'Datos: ' + parts.join(', ');
            document.getElementById('detailDesc').textContent = m.desc || '';
            if(m.lat && m.lon){ map.setView([m.lat,m.lon],12); 
                // Abrir popup si el municipio tiene un marcador de ranking
                if(currentRankMarkers[m.id]) currentRankMarkers[m.id].openPopup(); 
                // Si no está en el ranking visible, añadir un marcador temporal si tiene coordenadas.
                else if (!currentRankMarkers[m.id]){
                    const tempMarker = L.marker([m.lat,m.lon]).addTo(markerLayer).bindPopup(`<strong>${m.name}</strong><br/>No en el top ${document.getElementById('mapLimit')?.value}`);
                    // Opcional: Centrar el mapa en él.
                    map.setView([m.lat,m.lon],12); 
                }
            }
        }

		// select ranking item 
		function selectRankingItem(idOrName){
            let m;
            if(typeof idOrName === 'number'){
                const el = document.getElementById('ranking-item-' + idOrName);
                document.querySelectorAll('.ranking-item.selected').forEach(x=>x.classList.remove('selected'));
                if(el){
                    el.classList.add('selected');
                    try{ el.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
                }
                m = lastSortedMap[idOrName] || municipios.find(x=>x.id===idOrName);
            } else if(typeof idOrName === 'string'){
                m = municipioMap[idOrName];
                document.querySelectorAll('.ranking-item.selected').forEach(x=>x.classList.remove('selected'));
                // Si el municipio seleccionado por nombre *está* en el ranking actual, lo marcamos.
                const rankItem = Object.values(lastSortedMap).find(item => item.name === idOrName);
                if(rankItem) {
                    const el = document.getElementById('ranking-item-' + rankItem.id);
                    if(el) {
                         el.classList.add('selected');
                         try{ el.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
                    }
                }
            }
            
            if(m) showDetail(m);
        }

		// get slider weights 
		function getSliderWeights(){
			const prefs = {
				educ: Number(document.getElementById('s-educ').value),
				sani: Number(document.getElementById('s-sani').value),
				ocio: Number(document.getElementById('s-ocio').value),
				cost: Number(document.getElementById('s-cost').value),
				mov: Number(document.getElementById('s-mov').value),
				econ: Number(document.getElementById('s-econ').value)
			};
			const vals = Object.values(prefs);
			const sum = vals.reduce((a,b)=>a+b,0) || 1;
			const weights = {};
			Object.keys(prefs).forEach(k=> weights[k] = prefs[k]/sum);
			return weights;
		}

		// run search 
		async function runSearch(opts={}){
            console.log('runSearch called', opts);
            try{
                if(opts.forceReload) csvLoaded = false; 
                await loadCSV().catch(()=>{ loadFallback(); });
            }catch(e){ console.warn('loadCSV failed, using fallback', e); loadFallback(); }
            
            // Cargar similares
            try{
                if(opts.forceReload) similaresLoaded = false;
                await loadSimilaresCSV();
            }catch(e){ console.warn('loadSimilaresCSV failed, skipping similares', e); }

            const weights = getSliderWeights();
            const sorted = computeScores(weights);

            const showAll = document.getElementById('showAllMap')?.checked;
            let mapLimit = 0;
            if(showAll){
                mapLimit = sorted.length;
            } else {
                mapLimit = Number(document.getElementById('mapLimit')?.value) || 0;
            }
            renderRanking(sorted, mapLimit);
        }
		
		// Helper para obtener imagen de Wikipedia 
		async function fetchWikiThumbnail(municipioName){
			if(!municipioName) return null;
			const title = municipioName.replace(/ /g, '_');
			const url = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
			try{
				const res = await fetch(url);
				if(!res.ok) return null;
				const data = await res.json();
				if(data && data.thumbnail && data.thumbnail.source) return data.thumbnail.source;
				// fallback: try English wiki
				const res2 = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`);
				if(res2.ok){
					const d2 = await res2.json();
					if(d2 && d2.thumbnail && d2.thumbnail.source) return d2.thumbnail.source;
				}
				return null;
			}catch(e){
				return null;
			}
		}

		// Obtener y renderizar la lista de municipios similares
        async function updateSimilaresFromCSV(municipioBaseName){
            const simDiv = document.getElementById('similaresList');
            simDiv.innerHTML = '';
            
            if (!municipioBaseName) {
                simDiv.innerHTML = '<div class="muted" style="text-align:center;padding:12px;">Selecciona o busca un municipio para ver sus similares.</div>';
                return;
            }

            const maxSimilares = Number(document.getElementById('s-similares')?.value) || 5;
            const placeholderImg = 'assets/municipio-placeholder.jpg'; 
            
            // Buscar la fila de datos similares que coincida con el municipio base
            const simRow = similaresData.find(row => row['municipio'] === municipioBaseName);

            if (!simRow) {
                 simDiv.innerHTML = `<div class="muted" style="text-align:center;padding:12px;">No se encontraron municipios similares para **${municipioBaseName}**.</div>`;
                 return;
            }
            
            let municipiosSimilaresEncontrados = 0;
            
            // Iterar sobre los campos sim1, sim2, ... hasta maxSimilares (o hasta que el campo no exista)
            for (let i = 1; i <= maxSimilares; i++) {
                const similarName = simRow[`sim${i}`];
                
                if (similarName && municipioMap[similarName]) {
                    const s = municipioMap[similarName]; // Datos del municipio similar de df_indices_categorias
                    const d = document.createElement('div'); d.className='sim-card';
                    const thumbDiv = document.createElement('div'); thumbDiv.className='thumb';
                    
                    // ... (resto de la lógica de renderizado de la tarjeta)
                    thumbDiv.innerHTML = '<svg width="56" height="40" viewBox="0 0 56 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="56" height="40" rx="6" fill="#f3f4f6"/></svg>';
                    d.appendChild(thumbDiv);
                    const content = document.createElement('div'); content.style.flex='1';
                    
                    content.innerHTML = `<strong style="display:block">${s.name}</strong><div class="muted">Similar a ${municipioBaseName}</div>`;
                    d.appendChild(content);
                    
                    // Usar el nombre para la selección ya que no están en el ranking
                    d.onclick = ()=> { 
                        selectRankingItem(s.name);
                    } 
                    simDiv.appendChild(d);
                    municipiosSimilaresEncontrados++;

                    // Async fetch thumbnail
                    fetchWikiThumbnail(s.name).then(imgUrl=>{
                        const img = document.createElement('img');
                        img.alt = s.name;
                        img.src = imgUrl || placeholderImg;
                        img.onerror = () => { img.src = placeholderImg; };
                        thumbDiv.innerHTML = '';
                        thumbDiv.appendChild(img);
                    }).catch(()=>{
                        thumbDiv.innerHTML = `<img src="${placeholderImg}" alt="${s.name}" onerror="this.src='${placeholderImg}'">`;
                    });
                }
            }
             if (municipiosSimilaresEncontrados === 0) {
                 simDiv.innerHTML = `<div class="muted" style="text-align:center;padding:12px;">No hay municipios similares válidos para **${municipioBaseName}**.</div>`;
            }
        }

		// attach slider display update and re-run search 
		const sliderIds = {educ:'s-educ',sani:'s-sani',ocio:'s-ocio',cost:'s-cost',mov:'s-mov',econ:'s-econ'};
        Object.keys(sliderIds).forEach(key=>{
            const el = document.getElementById(sliderIds[key]);
            const disp = document.getElementById('val-'+(key));
            el.addEventListener('input', ()=>{ disp.textContent = el.value; });
            el.addEventListener('change', ()=>{ runSearch({forceReload:false}); });
        });
        
        // Slider para similares
        const similaresSlider = document.getElementById('s-similares');
        const similaresDisp = document.getElementById('val-similares');
        similaresSlider.addEventListener('input', ()=>{ similaresDisp.textContent = similaresSlider.value; });

		// basic search box filter for the displayed ranking 
		document.getElementById('mainSearch').addEventListener('input', (e)=>{
			const q = e.target.value.toLowerCase();
			document.querySelectorAll('.ranking-item').forEach(item=>{
				const name = item.textContent.split('(')[0].replace(/[#\d\s]/g,'').toLowerCase(); // name filter logic
				item.style.display = q? (name.includes(q)?'block':'none') : 'block';
			});
		});

		// place input: center map on typed municipality if matches name 
		document.getElementById('placeInput').addEventListener('change', (e)=>{
            const q = e.target.value.toLowerCase();
            const found = municipios.find(m=>m.name && m.name.toLowerCase().includes(q));
            if(found) {
                showDetail(found);
                // Mostrar similares para el municipio buscado
                updateSimilaresFromCSV(found.name); 
            }
        });

		// initial load
		runSearch({forceReload:true}).catch(err=>{ console.warn('Initial runSearch failed, falling back', err); loadFallback(); renderRanking(municipios,20); });
	</script>
</body>
</html>