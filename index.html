<!doctype html>
<html lang="es">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Búsqueda de Municipios - Madrid</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="" crossorigin=""></script>
	<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

	<style>
		/* --- ESTILOS CONSOLIDADOS --- */
		:root{
			--bg: #dcfcf3; 			/* azul crema*/
			--card: #c0ebe6;
			--accent: #011b30; 		/* color dominante oscuro */
			--accent-strong: #033d4a; /* color de acento para ranking/marcadores */
			--muted: #19191c;
			--separator: rgba(31,78,121,0.08);
			--gap: 12px;
		}
        
	    /* body + layout tweaks (from original, enhanced with theme) */
		html,body{height:100vh;width:100vw;margin:0;padding:0;box-sizing:border-box;overflow:hidden;font-family:'Roboto',Inter,Segoe UI,Arial;color:#0f1724;background:var(--bg)}
		.app{display:flex;flex-direction:column;height:100vh}
				
	/* Header with absolute rotator */
	header{position:relative; padding:12px 20px 8px; background:var(--bg); border-bottom:none;}
	header h1{margin:0 auto; font-size:48px; color:var(--accent); font-weight:700; white-space:normal; text-align:center; max-width:calc(100vw - 400px);}
				
		.topbar-search{position:absolute; right:55px; top:50%; transform:translateY(-50%); width:320px}
		.search-input{width:100%;padding:14px 16px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);box-shadow:0 1px 2px rgba(16,24,40,.03);font-size:16px}

		/* Grid Layout */
		.container{flex:1;display:grid;grid-template-columns:0.3fr 1fr 0.25fr;grid-template-rows:1fr 420px;gap:var(--gap);padding:14px 14px 46px;min-height:0}
		.left{grid-column:1/2;grid-row:1/2;padding:8px;overflow:auto;}
		.center{grid-column:2/3;grid-row:1/2;background:var(--card);border-radius:10px;padding:6px;display:flex;flex-direction:column;min-height:0;border:1px solid var(--separator);box-shadow:0 2px 5px rgba(16,24,40,.03)}
		.right{grid-column:3/4;grid-row:1/2;background:var(--card);padding:8px;border-radius:10px;overflow:auto;border:1px solid var(--separator);box-shadow:0 2px 5px rgba(16,24,40,.03)}
		/* allow the right column to shrink on small widths so inputs don't overflow */
		.right{min-width:0}
						
		/* Fila inferior con 3 columnas independientes: Ranking | Descripción | Chatbot */
		/* Aumentamos la fracción de la tercera columna para dar más anchura al Chatbot */
		.bottom{grid-column:1/4;grid-row:2/3;display:grid;grid-template-columns:0.4fr 1fr 0.7fr; gap:12px;min-height:0}

		/* Cards y Contenido Scrolleable */
		.bottom .card{height:100%;display:flex;flex-direction:column;overflow:hidden;}
		.card{background:var(--card);border-radius:10px;padding:8px;box-shadow:0 2px 5px rgba(16,24,40,.03); border:1px solid var(--separator);}
						
		.ranking-list-content, .detail-content{
			padding:0 12px 36px 12px; /* Ajuste para scroll y espacio inferior */
			flex:1;
			overflow-y:auto; 
		}

		/* Ajustes específicos para el buscador dentro del panel Ranking */
		.ranking-search{display:block;padding:6px 12px}
		.ranking-search .search-input{width:100%;max-width:none;padding:10px 12px;border-radius:8px;box-sizing:border-box}

		/* Ensure inputs and textareas inside the right panel never overflow */
		.right input[type="text"], .right input[type="number"], .right input[type="range"], .right input, .right textarea, #placeInput{ max-width:100%; box-sizing:border-box; }
						
		#map{height:100%;border-radius:8px}

		/* SIMILARES card look */
		.sim-card{
			display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);
			background:linear-gradient(180deg,rgba(255,255,255,0.7),rgba(255,255,255,0.9));
			cursor: pointer;
		}
		.sim-card:hover{background:linear-gradient(180deg,rgba(250,250,250,0.8),rgba(255,255,255,0.95));}
		.sim-card .thumb{
			width:56px;height:40px;border-radius:6px;background:#f3f4f6;overflow:hidden;flex:0 0 56px;display:flex;align-items:center;justify-content:center;
		}
		.sim-card .thumb img{width:100%;height:100%;object-fit:cover;display:block;transition:opacity 0.3s}

		/* Slider look and feel */
		.sliders label{display:flex;justify-content:space-between;font-size:13px;margin-top:10px;color:var(--muted)}
	    input[type=range]{-webkit-appearance:none;width:100%;height:8px;border-radius:6px;background:linear-gradient(90deg,var(--accent-strong),#a8c7f0);outline:none}
		input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);box-shadow:0 2px 6px rgba(31,78,121,0.18);border:2px solid #fff;margin-top:-5px}
		input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--accent);border:2px solid #fff}

		.sep{height:1px;background:var(--separator);margin:12px 0;border-radius:1px}

		/* Sponsor slider inside header */
		.sponsor-rotator{
			position:absolute;
			left:20px;
			top:50%;
			transform:translateY(-50%);
			width: clamp(250px, 20vw, 350px);
			height: clamp(70px, 9vh, 90px);
			overflow-x:hidden;
			overflow-y:hidden;
			background:transparent;
			pointer-events:auto;
			display: flex;
			align-items: center;
		}

		.sponsor-track{
			display:flex;
			align-items:center;
			gap: clamp(8px, 2vw, 20px);
			padding:0;
			box-sizing:border-box;
			flex-wrap:nowrap;
			min-width: max-content;
			animation:slide-left 6s linear infinite;
		}

		.sponsor-track img{
			height: clamp(30px, 4vh, 48px);
			width:auto;
			display:inline-block;
			object-fit:contain;
			opacity:1;
			transition:transform .25s ease, opacity .25s ease;
			flex:0 0 auto;
		}

		@keyframes slide-left{
			0%   { transform:translateX(0); }
			100% { transform:translateX(-50%); } 
		}

		/* Mobile adjustments */
		@media (max-width:900px){
			.container{grid-template-columns:1fr;grid-template-rows:minmax(0, 1fr) 1fr 320px 360px; }
			.left{grid-column:1/2;grid-row:3/4; height: 320px;}
			.right{grid-column:1/2;grid-row:2/3}
			.center{grid-column:1/2;grid-row:1/2}
			.bottom{grid-row:4/5;grid-column:1/2;grid-template-columns:1fr;}

			header {
				flex-direction: column;
				align-items: flex-start;
				padding: 10px 18px 18px 18px;
				min-height: 100px;
			}
			header h1 {
				font-size: 24px;
				order: 2;
				margin-top: 12px;
			}
			.topbar-search{
				position: static;
				width: 100%;
				margin-top: 10px;
				order: 3;
				transform: none;
			}

			.sponsor-rotator{
				position: static;
				width: 100%;
				height: 56px;
				left: auto;
				top: auto;
				overflow-x: auto;
				order: 1;
			}
			.sponsor-track{
				animation: none;
				gap: 16px;
				padding: 0 0 0 4px;
			}
			.sponsor-track img{
				height: 48px;
			}
		}
		@media (max-width:700px){
			header {
				flex-direction: column;
				gap: 10px;
			}
			header h1 {
				flex: none;
				text-align: left;
				line-height: 1.2;
				margin: 0;
				font-size: 22px;
			}
			.sponsor-rotator {
				width: 100%;
				margin-bottom: 5px;
			}
		}

		.ranking-item{padding:8px;border-bottom:1px dashed var(--separator);cursor:pointer}
		.ranking-item:hover{background:#fcfdfe}
		.muted{color:var(--muted);font-size:13px}
		.ranking-item.selected{background:linear-gradient(90deg,var(--separator),#fcfdfe);border-left:4px solid var(--accent-strong);}

		.detail-table{width:100%;border-collapse:collapse;margin-top:8px;margin-bottom:8px;border:1px solid rgba(3,61,74,0.08);box-shadow:0 1px 0 rgba(0,0,0,0.03)}
		.detail-table th{background:rgba(3,61,74,0.04);color:var(--accent-strong);font-weight:700;padding:8px 10px;border:1px solid rgba(3,61,74,0.12);text-align:left;font-size:13px}
		.detail-table td{padding:8px 10px;border:1px solid rgba(3,61,74,0.08);font-size:13px;background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96))}

		/* etiqueta fija sobre la ruta */
		.route-label{
			background: rgba(0,0,0,0.7);
			color: #fff;
			padding:6px 8px;border-radius:6px;font-weight:700;font-size:13px;box-shadow:0 2px 6px rgba(0,0,0,0.25);
		}

		/* Modal styles */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 10000;
		}
		.modal {
			background: #fff;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
			max-width: 500px;
			font-size: 14px;
			line-height: 1.5;
			text-align: left;
			position: relative;
		}
		.modal button {
			margin-top: 15px;
			padding: 8px 16px;
			background: var(--accent);
			color: #fff;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}

		/* Chatbot styles */
		/* Make the chat container use flex so messages area stays scrollable
		   and the input/button remain pinned to the bottom. */
		#chatbot { display:flex; flex-direction:column; flex:1; min-height:0; gap:8px; }
		#chatbot .chat-controls{display:flex;gap:8px;align-items:center;padding:0 6px}
		/* Allow messages area to shrink and scroll without pushing the input */
		#chatbot .messages{flex:1; min-height:0; overflow:auto; padding:10px; background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)); border-radius:6px; border:1px solid rgba(3,61,74,0.04)}
		.message{margin-bottom:10px;max-width:100%;display:flex}
		.message.user{justify-content:flex-end}
		.message .bubble{padding:10px 12px;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.05);font-size:17px}
		.message.user .bubble{background:#2b7be4;color:#fff;border-bottom-right-radius:2px}
		.message.assistant .bubble{background:#f3f4f6;color:#0f1724;border-bottom-left-radius:2px}
		.chat-input{display:flex;gap:8px;padding:6px; flex:0 0 auto}
		.chat-input textarea{flex:1;resize:none;padding:8px;border-radius:8px;border:1px solid var(--separator);min-height:42px}
		.chat-input button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff}
		.api-key{flex:1;display:flex;gap:6px;align-items:center}
		.api-key input{flex:1;padding:6px;border-radius:6px;border:1px solid var(--separator)}
		
	</style>
</head>
<body>
	<div class="app">

	<header>
			<div class="title-container">
				<h1>Tu Municipio Ideal: Un Asistente para Decidir con Datos</h1>
			</div>
			<div class="sponsor-rotator" id="sponsorRot">
				<div class="sponsor-track" id="sponsorTrack">
					<img src="logos/logo1.png" alt="Patrocinador 1">
					<img src="logos/logo2.png" alt="Patrocinador 2">
					<img src="logos/logo3.png" alt="Patrocinador 3">
					<img src="logos/logo1.png" alt="Patrocinador 1">
					<img src="logos/logo2.png" alt="Patrocinador 2">
					<img src="logos/logo3.png" alt="Patrocinador 3">
				</div>
			</div>
		</header>

		<main class="container">
			<aside class="left card">
				<h3>SIMILARES</h3>
				<label>Número de similares a mostrar: <span id="val-similares">10</span></label>
                <input type="range" id="s-similares" min="1" max="10" value="10" />
                <hr class="sep" />
                <div id="similaresList" class="ranking-list-content"> 
                    </div>
			</aside>

			<section class="center"> 
				<div style="flex:1;min-height:0">
					<div id="map" style="height:100%"></div>
				</div>
			</section>

			<aside class="right"> 
				<h3>¿CUÁNTO VALORAS...?</h3>
				<div class="sliders">
					<label>Educación <span id="val-educ">5</span></label>
					<input type="range" id="s-educ" min="0" max="10" value="5" />

					<label>Sanidad <span id="val-sani">5</span></label>
					<input type="range" id="s-sani" min="0" max="10" value="5" />

					<label>Ocio y cultura <span id="val-ocio">5</span></label>
					<input type="range" id="s-ocio" min="0" max="10" value="5" />

					<label>Bienestar y servicios <span id="val-cost">5</span></label>
					<input type="range" id="s-cost" min="0" max="10" value="5" />

					<label>Movilidad <span id="val-mov">5</span></label>
					<input type="range" id="s-mov" min="0" max="10" value="5" />

					<label>Economía y empleo <span id="val-econ">5</span></label>
					<input type="range" id="s-econ" min="0" max="10" value="5" />
				</div>

				<hr class="sep" />
				<h4>Lugar de Interés</h4>
				<input id="placeInput" placeholder="Introduce una ubicación que visitas frecuentemente" style="width:100%;padding:10px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);margin-bottom:12px" />
				
				<button id="buscarBtn" style="width:100%;padding:10px 12px;background:var(--accent);color:#fff;border:none;border-radius:6px;">Buscar</button>

				<div style="margin-top:12px;margin-bottom:8px">
					<input type="checkbox" id="colorZones" checked>
					<label for="colorZones" style="margin-left:6px;margin-top:0">Colorear zonas (aprox.)</label>
				</div>

				<div style="margin-top:8px;display:flex;align-items:center;margin-bottom:8px;gap:8px">
					<label style="margin-right:8px;color:var(--muted);margin-top:0">Mostrar en mapa:</label>
					<input type="range" id="mapLimitSlider" min="1" max="10" value="10" style="flex:1">
					<div style="min-width:54px;text-align:right;color:var(--muted)"><strong id="mapLimitVal">10</strong></div>
				</div>
				
				<div style="margin-top:6px">
					<input type="checkbox" id="showAllMap">
					<label for="showAllMap" style="margin-left:6px;margin-top:0">Mostrar todas en mapa</label>
				</div>

				<div style="margin-top:8px">
					<input type="checkbox" id="useRouting">
					<label for="useRouting" style="margin-left:6px;margin-top:0">Trazar ruta por carretera (OSRM)</label>
				</div>
			</aside>

			<section class="bottom">
				<div class="card"> 
					<h3 style="padding:0 12px">Ranking</h3>
					<div class="ranking-search" style="padding:0 12px 8px;">
						<input class="search-input" id="mainSearch" placeholder="Búsqueda de municipios ➤ " />
					</div>
					<div id="ranking" class="ranking-list-content"></div> 
				</div>
			
				<div class="card"> 
					<h3 id="detailTitle" style="padding:0 12px">Selecciona un municipio</h3>
					<div id="detailContent" class="detail-content"> 
						<div id="detailProfile" class="muted">
							<table class="detail-table">
								<thead><tr><th>Educación</th><th>Sanidad</th><th>Ocio y cultura</th><th>Bienestar y servicios</th><th>Transporte y conectividad</th><th>Economía y empleo</th></tr></thead>
								<tbody><tr><td>—</td><td>—</td><td>—</td><td>—</td><td>—</td><td>—</td></tr></tbody>
							</table>
						</div>
						<div id="detailRoute" class="muted" style="margin-top:6px"></div>
						<h4>BREVE DESCRIPCIÓN DEL MUNICIPIO</h4>
						<p id="detailDesc">Aquí aparecerá una pequeña descripción cuando selecciones un municipio del ranking.</p>
					</div>
				</div>
			
				<div class="card" id="chatbot-placeholder">
					<h3 style="padding:0 12px">ChatBot Asistente</h3>
					<div id="chatbot">
						<!-- chat-controls removed per request -->
						<div class="messages" id="chatMessages" aria-live="polite"></div>
						<div class="chat-input">
							<textarea id="chatInput" placeholder="Escribe tu pregunta aquí..."></textarea>
							<button id="sendChatBtn">Enviar</button>
						</div>
					</div>
				</div>
			</section>
		</main>
		</div>

		<!-- Modal for info explanation -->
		<div id="infoModal" class="modal-overlay" style="display:none;">
			<div class="modal">
				<p></p>
				<button onclick="hideInfoModal()">Cerrar</button>
			</div>
		</div>

		<!-- Load local secrets (secrets.js) which defines window.SECRETS.OPENROUTER_API_KEY -->
		<script src="secrets.js"></script>
		<script>
		// app state
		let municipios = []; 
		let similaresData = []; // Para almacenar los datos de municipios_similares.csv
		// Ruta base para los datos (permite cambiar fácilmente la carpeta de origen)
		const DATA_PATH = 'website_data/';
		const markers = {};
		let lastRouteInfo = null; // {distance: meters, duration: seconds, source: 'osrm'|'straight'}

		// Map setup (Leaflet already included)
		const map = L.map('map', {zoomControl:true}).setView([40.4168,-3.7038],10);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);

		const markerLayer = L.layerGroup().addTo(map);
		let currentRankMarkers = {}; 
		let lastSortedMap = {}; 
		const areaLayer = L.layerGroup().addTo(map);
		// layer to show the user's "Lugar de Interés" (single red marker)
		const interestLayer = L.layerGroup().addTo(map);
		// layer to draw connection line between selected municipio and interest point
		const connectionLayer = L.layerGroup().addTo(map);
		// layer to draw routed path (OSRM)
		const routeLayer = L.layerGroup().addTo(map);
		let municipioMap = {}; // Mapa para acceder rápidamente a un municipio por nombre

		// Funcionalidad del botón Buscar (ahora en el HTML)
		const buscarBtn = document.getElementById('buscarBtn');
		buscarBtn.onclick = async ()=>{
			try{
				buscarBtn.disabled = true;
				buscarBtn.textContent = 'Buscando...';
				await runSearch({forceReload:true});
			}catch(e){
				console.error('Error en buscar:', e);
				alert('Error al buscar. Mira la consola para más detalles.');
			}finally{
				buscarBtn.disabled = false;
				buscarBtn.textContent = 'Buscar';
			}
		};

		// Auto-run search when map option checkboxes change
		document.querySelectorAll('.right input[type="checkbox"]').forEach(input=>{
			input.addEventListener('change', ()=>{ try{ runSearch({forceReload:false}); }catch(e){ console.error('runSearch error from change', e); } });
		});

		// Map limit slider (will have its max updated after CSV loads)
		const mapLimitSlider = document.getElementById('mapLimitSlider');
		if(mapLimitSlider){
			mapLimitSlider.addEventListener('input', ()=>{ document.getElementById('mapLimitVal').textContent = mapLimitSlider.value; });
			mapLimitSlider.addEventListener('change', ()=>{ try{ runSearch({forceReload:false}); }catch(e){ console.error('mapLimit change runSearch error', e); } });
		}

		// Auto-run search when similares slider changes
        document.getElementById('s-similares').addEventListener('change', ()=>{
            // Llamar a la función de similares con el municipio seleccionado o el rank 1
            const currentSelected = document.querySelector('.ranking-item.selected');
            if (currentSelected) {
                const id = parseInt(currentSelected.id.split('-')[2]);
                const m = lastSortedMap[id] || municipios.find(x=>x.id===id);
                if (m) {
                    updateSimilaresFromCSV(m.name);
                    return;
                }
            }
			// Fallback: usar el rank 1
            if (lastSortedMap && Object.keys(lastSortedMap).length > 0) {
                 const rank1 = Object.values(lastSortedMap).sort((a,b)=>b.score - a.score)[0];
                 if(rank1) updateSimilaresFromCSV(rank1.name);
            } else {
                 updateSimilaresFromCSV(null); // Borrar la lista si no hay ranking
            }
        });

		// mapping of slider keys to CSV columns 
		const columnMap = { educ:'educacion', sani:'sanidad', ocio:'ocio_cultura', cost:'bienestar', mov:'transporte_conectividad', econ:'economia_empleo' };

		// load CSV 
		let csvLoaded = false;
		function loadCSV(){
			return new Promise((resolve, reject)=>{
				if(csvLoaded) return resolve();
				Papa.parse(DATA_PATH + 'df_indices_categorias.csv', {
					download: true,
					header: true,
					dynamicTyping: true,
					skipEmptyLines: true,
					complete: function(results){
						municipios = results.data.map((r, i)=>({
							id: i+1,
							cod: r.cod_municipio,
							name: r.municipio || r.nombre || `Municipio ${i+1}`,
							lat: Number(r.latitud) || Number(r.latitude) || null,
							lon: Number(r.longitud) || Number(r.longitude) || null,
							alt: Number(r.altitud) || null,
							sanidad: Number(r.sanidad) || 0,
							educacion: Number(r.educacion) || 0,
							transporte_conectividad: Number(r.transporte_conectividad) || 0,
							economia_empleo: Number(r.economia_empleo) || 0,
							bienestar: Number(r.bienestar) || 0,
							ocio_cultura: Number(r.ocio_cultura) || 0,
							desc: r.descripcion || r.Descripcion || r.description || r.Description || ''
						}));
						csvLoaded = true;
						municipioMap = {}; // Reset map
						municipios.forEach(m=>{
							if(m.name) municipioMap[m.name.toLowerCase()] = m; // Llenar el mapa con clave lowercase
						});
                        resolve();
					},
					error: function(err){
						console.error('CSV load error', err);
						reject(err);
					}
				});
			});
		}

		// NUEVA: Cargar CSV de Similares
        let similaresLoaded = false;
        function loadSimilaresCSV(){
            return new Promise((resolve, reject)=>{
                if(similaresLoaded) return resolve();
				Papa.parse(DATA_PATH + 'municipios_similares.csv', {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results){
                        similaresData = results.data;
                        similaresLoaded = true;
                        resolve();
                    },
                    error: function(err){
                        console.error('Similares CSV load error', err);
                        // Fallback: usar los primeros 3 municipios del ranking como antes
                        similaresData = []; 
                        reject(err);
                    }
                });
            });
        }

		// fallback mock 
		function loadFallback(){
			municipios = [
				{id:1,name:'Alcalá de Henares',lat:40.481,lon:-3.363,educacion:8, sanidad:7, ocio_cultura:8, bienestar:6, transporte_conectividad:7, economia_empleo:7, desc:'Ciudad universitaria y con buena oferta cultural.'},
				{id:2,name:'Majadahonda',lat:40.453,lon:-3.873,educacion:7, sanidad:8, ocio_cultura:6, bienestar:6, transporte_conectividad:8, economia_empleo:6, desc:'Municipio residencial con buen acceso a Madrid.'},
				{id:3,name:'Getafe',lat:40.308,lon:-3.732,educacion:6, sanidad:6, ocio_cultura:7, bienestar:6, transporte_conectividad:7, economia_empleo:8, desc:'Ciudad con gran actividad industrial y universitaria.'}
			];
			municipioMap = {};
			municipios.forEach(m=>{ if(m.name) municipioMap[m.name.toLowerCase()] = m; });
            csvLoaded = false;
		}

		// compute scores 
		function computeScores(weights){
			const scored = municipios.map(m=>{
				let s = 0;
				Object.keys(columnMap).forEach(k=>{
					const col = columnMap[k];
					const w = weights[k] || 0;
					const v = isFinite(m[col])? m[col] : 0; 
					s += w * v;
				});
				return {...m, score: s };
			});
			return scored.sort((a,b)=>b.score - a.score);
		}

		// create numbered marker 
		function createNumberedMarker(m, rank){
			const numberHtml = `<div style="background:${rank===1?'#ffc107':'#2b7be4'};color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid #fff;box-shadow:0 1px 2px rgba(0,0,0,.2)">${rank}</div>`;
			const icon = L.divIcon({className:'number-icon', html:numberHtml, iconSize:[30,30], iconAnchor:[15,30]});
			const marker = L.marker([m.lat,m.lon], {icon}).bindPopup(`<strong>#${rank} ${m.name}</strong><br/>Puntuación: ${(m.score*100).toFixed(1)}`);
			return marker;
		}

		// map score to color 
		function scoreToColor(score){
			const s = Math.max(0, Math.min(1, score));
			function lerpColor(a,b,t){
				return [
					Math.round(a[0] + (b[0]-a[0])*t),
					Math.round(a[1] + (b[1]-a[1])*t),
					Math.round(a[2] + (b[2]-a[2])*t)
				];
			}
			const red = [220,53,69]; 
			const yellow = [255,215,0];
			const green = [34,139,34]; 
			let rgb;
			if(s < 0.5){
				const t = s / 0.5;
				rgb = lerpColor(red, yellow, t);
			} else {
				const t = (s - 0.5) / 0.5;
				rgb = lerpColor(yellow, green, t);
			}
			return `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
		}

		// display names 
		const displayNames = {
			'educacion': 'Educación',
			'sanidad': 'Sanidad',
			'ocio_cultura': 'Ocio y cultura',
			'bienestar': 'Bienestar y servicios',
			'transporte_conectividad': 'Transporte y conectividad',
			'economia_empleo': 'Economía y empleo'
		};

		// render ranking 
		function renderRanking(sorted, mapLimit=20){
            const list = document.getElementById('ranking');
            list.innerHTML = '';

            markerLayer.clearLayers();
            currentRankMarkers = {};
            areaLayer.clearLayers();
            lastSortedMap = {};

            sorted.forEach((m, idx)=>{
                lastSortedMap[m.id] = m;
                const rank = idx+1;
                const div = document.createElement('div');
                div.className = 'ranking-item';
                div.id = 'ranking-item-' + m.id;
                const scoreText = isFinite(m.score)? `(Puntuación: ${(m.score*100).toFixed(1)})` : '';
                div.innerHTML = `<strong>#${rank} ${m.name}</strong> <div class="muted">${scoreText}</div>`;
                div.onclick = ()=> { 
                    selectRankingItem(m.id); 
                    updateSimilaresFromCSV(m.name); // NUEVO: Actualizar similares al hacer clic
                };
                div.onmouseenter = ()=> { if(currentRankMarkers[m.id]) currentRankMarkers[m.id].openPopup(); };
                div.onmouseleave = ()=> { if(currentRankMarkers[m.id]) currentRankMarkers[m.id].closePopup(); };
                list.appendChild(div);

                if(idx < mapLimit && m.lat && m.lon){
                    const mrk = createNumberedMarker(m, rank);
                    mrk.addTo(markerLayer);
                    mrk.on('click', ()=> {
                        selectRankingItem(m.id);
                        updateSimilaresFromCSV(m.name); // NUEVO: Actualizar similares al hacer clic en marcador
                    });
                    currentRankMarkers[m.id] = mrk;
                    const enableColor = document.getElementById('colorZones')?.checked;
                    if(enableColor){
                        const radius = 1250;
                        const c = L.circle([m.lat,m.lon], {radius: radius, color: scoreToColor(m.score), fillColor: scoreToColor(m.score), fillOpacity: 0.25, weight:1}).bindPopup(`<strong>#${rank} ${m.name}</strong><br/>Puntuación: ${(m.score*100).toFixed(1)}`);
                        c.addTo(areaLayer);
                        c.on('click', ()=> {
                             selectRankingItem(m.id);
                             updateSimilaresFromCSV(m.name); // NUEVO: Actualizar similares al hacer clic en zona
                        });
                    }
                }
            });

			// Mostrar similares para el Rank 1 por defecto
            if (sorted.length > 0) {
                updateSimilaresFromCSV(sorted[0].name); 
                selectRankingItem(sorted[0].id); // Seleccionar el rank 1 por defecto
            } else {
                updateSimilaresFromCSV(null);
            }
        }

		// show detail
		const explanation = 'El cálculo del puntuaje de las distintas categorías dependen de diferentes aspectos, como la cantidad de servicios disponibles (por ejemplo, número de centros de salud por cada 10.000 habitantes), las opiniones de los usuarios sobre esos servicios (como las valoraciones en Google Maps), y factores económicos como la tasa de desempleo, los cuales se combinan de manera equilibrada para obtener una puntuación final que refleja la calidad de vida en cada municipio.';

		function showDetail(m){
		    document.getElementById('detailTitle').textContent = m.name;
		    // Build a table of categories
		    const cols = ['educacion','sanidad','ocio_cultura','bienestar','transporte_conectividad','economia_empleo'];
		    const headers = cols.map(c=> displayNames[c] || c.replace('_',' '));
		    const values = cols.map(c=>{
		        const v = (c in m) ? m[c] : null;
		        return (v === null || v === undefined || !isFinite(v)) ? '—' : Number(v).toFixed(2);
		    });
		    // Add Info header and value
		    headers.push('Info');
		    values.push('<button onclick="showInfoModal()" style="padding: 4px 8px; background: rgba(0,0,0,0.08); border: none; border-radius: 3px; cursor: pointer;">?</button>');
		    // Render table into detailProfile
		    const table = document.createElement('table');
		    table.className = 'detail-table';
		    const thead = document.createElement('thead');
		    const trh = document.createElement('tr');
		    headers.forEach(h=>{ const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
		    thead.appendChild(trh);
		    const tbody = document.createElement('tbody');
		    const trv = document.createElement('tr');
		    values.forEach(v=>{ const td = document.createElement('td'); td.innerHTML = v; trv.appendChild(td); });
		    tbody.appendChild(trv);
		    table.appendChild(thead); table.appendChild(tbody);
		    const profileEl = document.getElementById('detailProfile');
		    profileEl.innerHTML = '';
		    profileEl.appendChild(table);

		    document.getElementById('detailDesc').textContent = m.desc || '';
			if(m.lat && m.lon){ map.setView([m.lat,m.lon],12); 
		        // Abrir popup si el municipio tiene un marcador de ranking
		        if(currentRankMarkers[m.id]) currentRankMarkers[m.id].openPopup(); 
		        // Si no está en el ranking visible, añadir un marcador temporal si tiene coordenadas.
		        else if (!currentRankMarkers[m.id]){
					const mapLimitDisplay = document.getElementById('mapLimitSlider') ? document.getElementById('mapLimitSlider').value : document.getElementById('mapLimit')?.value;
					const tempMarker = L.marker([m.lat,m.lon]).addTo(markerLayer).bindPopup(`<strong>${m.name}</strong><br/>No en el top ${mapLimitDisplay}`);
		            // Opcional: Centrar el mapa en él.
		            map.setView([m.lat,m.lon],12); 
		        }
				// Si hay un marcador de interés, dibujar la línea de conexión
				try{
					const interestLayers = interestLayer.getLayers();
					if(interestLayers && interestLayers.length>0){
						const il = interestLayers[0].getLatLng();
						drawConnectionBetween(m, il);
					} else {
						connectionLayer.clearLayers();
					}
				}catch(e){ console.warn('drawConnection error', e); }
		    }
		}

		// Dibuja una línea (o ruta) entre el municipio y el punto de interés (interestLatLng puede ser L.LatLng)
		async function drawConnectionBetween(municipioObj, interestLatLng){
			connectionLayer.clearLayers();
			routeLayer.clearLayers();
			if(!municipioObj || !interestLatLng) return;
			const a = (municipioObj.lat && municipioObj.lon) ? [municipioObj.lat, municipioObj.lon] : null;
			let b = null;
			if(interestLatLng.lat !== undefined){ b = [interestLatLng.lat, interestLatLng.lng !== undefined ? interestLatLng.lng : (interestLatLng.lon || interestLatLng[1])]; }
			if(!a || !b) return;
			// Si el usuario ha marcado usar routing, intentarlo con OSRM. Si falla, dibujar polyline simple.
			const useRouting = document.getElementById('useRouting')?.checked;
			if(useRouting){
				const ok = await routeBetweenPoints(a[0], a[1], b[0], b[1]);
				if(ok) return; // ruta dibujada por OSRM (lastRouteInfo ya configurado)
			}
			// Fallback: línea simple (distancia en línea recta)
			const poly = L.polyline([a,b], {color:'#dc3545', weight:3, dashArray:'6 4'}).addTo(connectionLayer);
			// calcular distancia Haversine
			function haversine(lat1,lon1,lat2,lon2){
				const R = 6371000; // m
				const toRad = v => v * Math.PI/180;
				const dLat = toRad(lat2-lat1);
				const dLon = toRad(lon2-lon1);
				const a1 = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
				const c = 2 * Math.atan2(Math.sqrt(a1), Math.sqrt(1-a1));
				return R * c;
			}
			const dist = haversine(a[0],a[1],b[0],b[1]);
			lastRouteInfo = {distance: dist, duration: null, source: 'straight'};
			updateDetailRoute();
			// añadir etiqueta sobre la línea en el punto medio
			try{
				const mid = [(a[0]+b[0])/2, (a[1]+b[1])/2];
				const labelText = `Línea: ${(dist/1000).toFixed(2)} km`;
				poly.bindTooltip(labelText, {permanent:true, direction:'center', className:'route-label', offset:[0,0]}).openTooltip(mid);
			}catch(e){/* ignore */}
			try{ const bounds = L.latLngBounds([a,b]); map.fitBounds(bounds.pad(0.15)); }catch(e){}
		}

		// select ranking item 
		function selectRankingItem(idOrName){
            let m;
            if(typeof idOrName === 'number'){
                const el = document.getElementById('ranking-item-' + idOrName);
                document.querySelectorAll('.ranking-item.selected').forEach(x=>x.classList.remove('selected'));
                if(el){
                    el.classList.add('selected');
                    try{ el.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
                }
                m = lastSortedMap[idOrName] || municipios.find(x=>x.id===idOrName);
            } else if(typeof idOrName === 'string'){
                m = municipioMap[idOrName];
                document.querySelectorAll('.ranking-item.selected').forEach(x=>x.classList.remove('selected'));
                // Si el municipio seleccionado por nombre *está* en el ranking actual, lo marcamos.
                const rankItem = Object.values(lastSortedMap).find(item => item.name === idOrName);
                if(rankItem) {
                    const el = document.getElementById('ranking-item-' + rankItem.id);
                    if(el) {
                         el.classList.add('selected');
                         try{ el.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
                    }
                }
            }
            
            if(m) showDetail(m);
        }

		// get slider weights 
		function getSliderWeights(){
			const prefs = {
				educ: Number(document.getElementById('s-educ').value),
				sani: Number(document.getElementById('s-sani').value),
				ocio: Number(document.getElementById('s-ocio').value),
				cost: Number(document.getElementById('s-cost').value),
				mov: Number(document.getElementById('s-mov').value),
				econ: Number(document.getElementById('s-econ').value)
			};
			const vals = Object.values(prefs);
			const sum = vals.reduce((a,b)=>a+b,0) || 1;
			const weights = {};
			Object.keys(prefs).forEach(k=> weights[k] = prefs[k]/sum);
			return weights;
		}

		// run search 
		async function runSearch(opts={}){
            console.log('runSearch called', opts);
            try{
                if(opts.forceReload) csvLoaded = false; 
				await loadCSV().catch(()=>{ loadFallback(); });
				// After CSV loads (or fallback), update the mapLimit slider max to the available municipios count
				try{
					const slider = document.getElementById('mapLimitSlider');
					if(slider){
						const maxCount = municipios && municipios.length ? municipios.length : 10;
						slider.max = Math.max(1, maxCount);
						// If current value is greater than max, clamp it
						if(Number(slider.value) > slider.max) slider.value = slider.max;
						const display = document.getElementById('mapLimitVal');
						if(display) display.textContent = slider.value;
					}
				}catch(e){console.warn('Failed to update mapLimitSlider max', e);}
            }catch(e){ console.warn('loadCSV failed, using fallback', e); loadFallback(); }
            
            // Cargar similares
            try{
                if(opts.forceReload) similaresLoaded = false;
                await loadSimilaresCSV();
            }catch(e){ console.warn('loadSimilaresCSV failed, skipping similares', e); }

            const weights = getSliderWeights();
            const sorted = computeScores(weights);

            const showAll = document.getElementById('showAllMap')?.checked;
            let mapLimit = 0;
			if(showAll){
				mapLimit = sorted.length;
			} else {
				const slider = document.getElementById('mapLimitSlider');
				mapLimit = slider ? Number(slider.value) || 0 : Number(document.getElementById('mapLimit')?.value) || 0;
			}
            renderRanking(sorted, mapLimit);
        }
		
		// Helper para obtener imagen de Wikipedia 
		async function fetchWikiThumbnail(municipioName){
			if(!municipioName) return null;
			const title = municipioName.replace(/ /g, '_');
			const url = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
			try{
				const res = await fetch(url);
				if(!res.ok) return null;
				const data = await res.json();
				if(data && data.thumbnail && data.thumbnail.source) return data.thumbnail.source;
				// fallback: try English wiki
				const res2 = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`);
				if(res2.ok){
					const d2 = await res2.json();
					if(d2 && d2.thumbnail && d2.thumbnail.source) return d2.thumbnail.source;
				}
				return null;
			}catch(e){
				return null;
			}
		}

		// Geocodificación OSM (Nominatim) - devuelve el primer resultado o null
		async function geocodeOSM(query){
			if(!query) return null;
			const base = 'https://nominatim.openstreetmap.org/search';
			const params = new URLSearchParams({format:'json', q: query, limit: '1', countrycodes: 'es', 'accept-language':'es'});
			const url = base + '?' + params.toString();
			try{
				const res = await fetch(url, {headers:{'Accept':'application/json'}});
				if(!res.ok) return null;
				const data = await res.json();
				if(data && data.length>0) return data[0];
			}catch(e){
				console.warn('Nominatim geocode error', e);
			}
			return null;
		}

		// Enrutamiento usando OSRM público: devuelve true si dibujó ruta
		async function routeBetweenPoints(aLat,aLon,bLat,bLon){
			routeLayer.clearLayers();
			connectionLayer.clearLayers();
			if(!aLat || !aLon || !bLat || !bLon) return false;
			const url = `https://router.project-osrm.org/route/v1/driving/${aLon},${aLat};${bLon},${bLat}?overview=full&geometries=geojson&alternatives=false&steps=false`;
			try{
				const res = await fetch(url);
				if(!res.ok) throw new Error('OSRM no respondió');
				const data = await res.json();
				if(data && data.routes && data.routes.length){
					const coords = data.routes[0].geometry.coordinates.map(c=>[c[1], c[0]]);
					const line = L.polyline(coords, {color:'#1e88e5', weight:4}).addTo(routeLayer);
						const dist = data.routes[0].distance || 0; // meters
						const dur = data.routes[0].duration || 0; // seconds
						// store last route info and update UI
						lastRouteInfo = {distance: dist, duration: dur, source: 'osrm'};
						updateDetailRoute();
						line.bindPopup(`Distancia: ${(dist/1000).toFixed(2)} km<br/>Duración: ${Math.round(dur/60)} min`);
						// añadir etiqueta permanente sobre la ruta (en el centro aproximado)
						try{
							const coordsMid = coords[Math.floor(coords.length/2)];
							const labelText = `Ruta: ${(dist/1000).toFixed(2)} km — ${Math.round(dur/60)} min`;
							line.bindTooltip(labelText, {permanent:true, direction:'center', className:'route-label', offset:[0,0]}).openTooltip(coordsMid);
						}catch(e){/* ignore */}
					return true;
				}
			}catch(e){
				console.warn('OSRM routing failed', e);
			}
			return false;
		}

		// Actualiza el panel de detalle con la información de ruta/linea si existe
		function updateDetailRoute(){
			const el = document.getElementById('detailRoute');
			if(!el) return;
			if(!lastRouteInfo){ el.textContent = ''; return; }
			if(lastRouteInfo.source === 'osrm'){
				const km = (lastRouteInfo.distance/1000).toFixed(2);
				const min = Math.round((lastRouteInfo.duration||0)/60);
				el.innerHTML = `<strong>Ruta (carretera)</strong>: ${km} km — ${min} min`;
			} else if(lastRouteInfo.source === 'straight'){
				const km = (lastRouteInfo.distance/1000).toFixed(2);
				el.innerHTML = `<strong>Línea recta</strong>: ${km} km`;
			} else {
				el.textContent = '';
			}
		}

		// Obtener y renderizar la lista de municipios similares
		async function updateSimilaresFromCSV(municipioBaseName){
			const simDiv = document.getElementById('similaresList');
			simDiv.innerHTML = '';

			if (!municipioBaseName) {
				simDiv.innerHTML = '<div class="muted" style="text-align:center;padding:12px;">Selecciona o busca un municipio para ver sus similares.</div>';
				return;
			}

			const maxSimilares = Number(document.getElementById('s-similares')?.value) || 5;
			const placeholderImg = 'assets/municipio-placeholder.jpg';

			// Buscar la fila de datos similares que coincida con el municipio base (case-insensitive)
			let simRow = null;
			if(Array.isArray(similaresData) && similaresData.length>0){
				const target = municipioBaseName.toString().trim().toLowerCase();
				simRow = similaresData.find(row => {
					const m = (row['municipio'] || row['Municipio'] || row['municipio_base'] || '').toString().trim().toLowerCase();
					return m && m === target;
				});
			}

			// If we have a simRow, use it. Otherwise fallback to top-N from the current ranking or the municipios list.
			if (simRow) {
				let municipiosSimilaresEncontrados = 0;
				for (let i = 1; i <= maxSimilares; i++) {
					const similarName = simRow[`sim${i}`] || simRow[`SIM${i}`] || simRow[`Sim${i}`];
					if (similarName) {
						// try case-insensitive lookup in municipioMap
						const s = municipioMap[similarName.toString().trim().toLowerCase()];
						if (s) {
							const d = document.createElement('div'); d.className='sim-card';
							const thumbDiv = document.createElement('div'); thumbDiv.className='thumb';
							thumbDiv.innerHTML = '<svg width="56" height="40" viewBox="0 0 56 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="56" height="40" rx="6" fill="#f3f4f6"/></svg>';
							d.appendChild(thumbDiv);
							const content = document.createElement('div'); content.style.flex='1';
							content.innerHTML = `<strong style="display:block">${s.name}</strong><div class="muted">Similar a ${municipioBaseName}</div>`;
							d.appendChild(content);
							d.onclick = ()=> { selectRankingItem(s.name); }
							simDiv.appendChild(d);
							municipiosSimilaresEncontrados++;

							fetchWikiThumbnail(s.name).then(imgUrl=>{
								const img = document.createElement('img');
								img.alt = s.name;
								img.src = imgUrl || placeholderImg;
								img.onerror = () => { img.src = placeholderImg; };
								thumbDiv.innerHTML = '';
								thumbDiv.appendChild(img);
							}).catch(()=>{ thumbDiv.innerHTML = `<img src="${placeholderImg}" alt="${s.name}" onerror="this.src='${placeholderImg}'">`; });
						}
					}
				}
				if (municipiosSimilaresEncontrados === 0) {
					simDiv.innerHTML = `<div class="muted" style="text-align:center;padding:12px;">No hay municipios similares válidos para **${municipioBaseName}**.</div>`;
				}
				return;
			}

			// Fallback: si no hay archivo de similares o no se encontró la fila, tomar top-N del ranking
			const candidates = Object.values(lastSortedMap).length ? Object.values(lastSortedMap) : municipios;
			if(!candidates || candidates.length===0){
				simDiv.innerHTML = `<div class="muted" style="text-align:center;padding:12px;">No hay datos disponibles para generar similares.</div>`;
				return;
			}

			let added = 0;
			const baseLower = municipioBaseName.toString().trim().toLowerCase();
			for(const item of candidates){
				if(added >= maxSimilares) break;
				if(!item || !item.name) continue;
				if(item.name.toString().trim().toLowerCase() === baseLower) continue; // skip the base itself
				const s = item;
				const d = document.createElement('div'); d.className='sim-card';
				const thumbDiv = document.createElement('div'); thumbDiv.className='thumb';
				thumbDiv.innerHTML = '<svg width="56" height="40" viewBox="0 0 56 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="56" height="40" rx="6" fill="#f3f4f6"/></svg>';
				d.appendChild(thumbDiv);
				const content = document.createElement('div'); content.style.flex='1';
				content.innerHTML = `<strong style="display:block">${s.name}</strong><div class="muted">Sugerido — similar por ranking</div>`;
				d.appendChild(content);
				d.onclick = ()=> { selectRankingItem(s.id || s.name); }
				simDiv.appendChild(d);

				fetchWikiThumbnail(s.name).then(imgUrl=>{
					const img = document.createElement('img');
					img.alt = s.name;
					img.src = imgUrl || placeholderImg;
					img.onerror = () => { img.src = placeholderImg; };
					thumbDiv.innerHTML = '';
					thumbDiv.appendChild(img);
				}).catch(()=>{ thumbDiv.innerHTML = `<img src="${placeholderImg}" alt="${s.name}" onerror="this.src='${placeholderImg}'">`; });

				added++;
			}

			if(added === 0){
				simDiv.innerHTML = `<div class="muted" style="text-align:center;padding:12px;">No se encontraron similares (ni CSV ni ranking disponible).</div>`;
			}
		}

		// attach slider display update and re-run search 
		const sliderIds = {educ:'s-educ',sani:'s-sani',ocio:'s-ocio',cost:'s-cost',mov:'s-mov',econ:'s-econ'};
        Object.keys(sliderIds).forEach(key=>{
            const el = document.getElementById(sliderIds[key]);
            const disp = document.getElementById('val-'+(key));
            el.addEventListener('input', ()=>{ disp.textContent = el.value; });
            el.addEventListener('change', ()=>{ runSearch({forceReload:false}); });
        });
        
        // Slider para similares
        const similaresSlider = document.getElementById('s-similares');
        const similaresDisp = document.getElementById('val-similares');
        similaresSlider.addEventListener('input', ()=>{ similaresDisp.textContent = similaresSlider.value; });

		// basic search box filter for the displayed ranking
		document.getElementById('mainSearch').addEventListener('input', (e)=>{
			const qRaw = e.target.value.toLowerCase();
			const q = qRaw.replace(/\s+/g,''); // normalize: remove spaces so searches with spaces match
			document.querySelectorAll('.ranking-item').forEach(item=>{
				const name = item.textContent.split('(')[0].replace(/[#\d\s]/g,'').toLowerCase(); // name filter logic
				const nameNorm = name.replace(/\s+/g,'');
				item.style.display = q ? (nameNorm.includes(q) ? 'block' : 'none') : 'block';
			});
		});

		// Modal functions for info
		function showInfoModal() {
			const p = document.getElementById('infoModal').querySelector('p');
			p.innerHTML = explanation;
			document.getElementById('infoModal').style.display = 'flex';
		}
		function hideInfoModal() {
			document.getElementById('infoModal').style.display = 'none';
		}

		// place input: center map on typed municipality; use CSV match or fallback to OSM (Nominatim)
		document.getElementById('placeInput').addEventListener('change', async (e)=>{
			const qRaw = (e.target.value || '').trim();
			const q = qRaw.toLowerCase();
			if(!q){ interestLayer.clearLayers(); connectionLayer.clearLayers(); routeLayer.clearLayers(); lastRouteInfo = null; updateDetailRoute(); return; }

			// try exact lookup in municipioMap (lowercase keys), then fallback to substring search
			let found = municipioMap[q] || municipios.find(m=>m.name && m.name.toLowerCase().includes(q));

			// If nothing found and CSV not loaded, try forcing CSV load (maybe user typed early)
			if(!found && !csvLoaded){
				try{ await runSearch({forceReload:true}); }catch(err){ console.warn('force reload in placeInput failed', err); }
				found = municipioMap[q] || municipios.find(m=>m.name && m.name.toLowerCase().includes(q));
			}

			if(found){
				showDetail(found);
				updateSimilaresFromCSV(found.name);
				if(found.lat && found.lon){
					// create/update red interest marker
					interestLayer.clearLayers();
					const redHtml = `<div style="background:#dc3545;color:#fff;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.25)">•</div>`;
					const icon = L.divIcon({className:'interest-icon', html:redHtml, iconSize:[26,26], iconAnchor:[13,13]});
					const mkr = L.marker([found.lat, found.lon], {icon}).bindPopup(`<strong>Lugar de interés</strong><br/>${found.name}`);
					mkr.addTo(interestLayer);
					mkr.openPopup();
					map.setView([found.lat, found.lon], 12);
					// Dibujar conexión si hay un municipio seleccionado
					try{ const sel = document.querySelector('.ranking-item.selected'); if(sel){ const id = parseInt(sel.id.split('-')[2]); const selM = lastSortedMap[id] || municipios.find(x=>x.id===id); if(selM) drawConnectionBetween(selM, mkr.getLatLng()); } }catch(e){console.warn('connect after interest (csv) failed', e);} 
				} else {
					alert('Ubicación encontrada pero no tiene coordenadas para mostrar en el mapa.');
				}
								// Dibujar conexión si hay un municipio seleccionado
								try{ const sel = document.querySelector('.ranking-item.selected'); if(sel){ const id = parseInt(sel.id.split('-')[2]); const selM = lastSortedMap[id] || municipios.find(x=>x.id===id); if(selM) drawConnectionBetween(selM, mkr.getLatLng()); } }catch(e){console.warn('connect after interest (osm) failed', e);} 
			} else {
				// If not found in CSV, try geocoding against OSM/Nominatim
				const osm = await geocodeOSM(qRaw);
				if(osm && osm.lat && osm.lon){
					const temp = { id: 'osm-'+Date.now(), name: osm.display_name || qRaw, lat: Number(osm.lat), lon: Number(osm.lon), desc: 'Resultado geocodificado desde OpenStreetMap (Nominatim).', isExternal: true };
					// Show detail but don't try to fetch similares (not in CSV)
					showDetail(temp);
					document.getElementById('similaresList').innerHTML = `<div class="muted" style="text-align:center;padding:12px;">Ubicación geocodificada desde OSM: no está en el CSV.</div>`;

					// create/update red interest marker
					interestLayer.clearLayers();
					const redHtml = `<div style="background:#dc3545;color:#fff;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.25)">•</div>`;
					const icon = L.divIcon({className:'interest-icon', html:redHtml, iconSize:[26,26], iconAnchor:[13,13]});
					const mkr = L.marker([temp.lat, temp.lon], {icon}).bindPopup(`<strong>Lugar de interés (OSM)</strong><br/>${temp.name}`);
					mkr.addTo(interestLayer);
					mkr.openPopup();
					map.setView([temp.lat, temp.lon], 12);
					// Dibujar conexión si hay un municipio seleccionado
					try{ const sel = document.querySelector('.ranking-item.selected'); if(sel){ const id = parseInt(sel.id.split('-')[2]); const selM = lastSortedMap[id] || municipios.find(x=>x.id===id); if(selM) drawConnectionBetween(selM, mkr.getLatLng()); } }catch(e){console.warn('connect after interest (osm) failed', e);} 
				} else {
					alert('No se encontró ningún municipio que coincida con: ' + (qRaw||''));
				}
			}
		});

		// initial load
		// Chatbot implementation (front-end demo with optional real API call)
		function renderChatMessage(role, text){
			const container = document.getElementById('chatMessages');
			const wrap = document.createElement('div');
			wrap.className = 'message ' + (role === 'user' ? 'user' : 'assistant');
			const bubble = document.createElement('div');
			bubble.className = 'bubble';
			bubble.textContent = text;
			wrap.appendChild(bubble);
			container.appendChild(wrap);
			container.scrollTop = container.scrollHeight;
		}

		async function callOpenRouterAPI(messages, apiKey){
			const url = "https://openrouter.ai/api/v1/chat/completions";
			const headers = {
				"Authorization": `Bearer ${apiKey || 'DUMMY'}`,
				"Content-Type": "application/json"
			};
			const payload = {
				model: "deepseek/deepseek-chat-v3.1",
				messages: messages
			};
			try{
				const res = await fetch(url, {method:'POST', headers, body: JSON.stringify(payload)});
				if(!res.ok) throw new Error('Network response not ok');
				const data = await res.json();
				// Try to extract a sensible assistant message from response (demo - may vary by API)
				if(data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content){
					return data.choices[0].message.content;
				}
				if(data && data.output && data.output[0] && data.output[0].content) return data.output[0].content;
				return JSON.stringify(data);
			}catch(err){
				console.warn('OpenRouter API call failed, falling back to dummy. Error:', err);
				throw err;
			}
		}

		function simulateAssistantReply(userText){
			// Very simple demo responses; can be enhanced.
			const u = userText.toLowerCase();
			if(u.includes('ruta') || u.includes('distancia')) return 'Puedo estimar la distancia y ruta entre municipios si seleccionas un punto de interés.';
			if(u.includes('educ') || u.includes('escuela')) return 'La educación es uno de los factores que ponderamos. Ajusta el slider para priorizarla.';
			return 'Esto es una respuesta demo. (API real no configurada o CORS bloqueó la llamada).';
		}

		// API key loaded from `secrets.js` on the client. If not present, EMBEDDED_API_KEY will be null.
		// Note: keeping secrets in a client-side file is still not secure for production. Prefer a server-side proxy.
		const EMBEDDED_API_KEY = (window && window.SECRETS && window.SECRETS.OPENROUTER_API_KEY) ? window.SECRETS.OPENROUTER_API_KEY : null;
		// Dummy mode disabled by default when control buttons are removed
		const USE_DUMMY = false;
		async function sendChatMessage(){
			const ta = document.getElementById('chatInput');
			const text = (ta.value || '').trim();
			if(!text) return;
			renderChatMessage('user', text);
			ta.value = '';
			const apiKey = EMBEDDED_API_KEY;
			const useDummy = USE_DUMMY;
			renderChatMessage('assistant', '...');
			// remove the last assistant placeholder when actual reply arrives
			const container = document.getElementById('chatMessages');
			const lastPlaceholder = container.querySelector('.message.assistant:last-child .bubble');
			try{
				let reply;
				if(!useDummy){
					// Build messages array with a system prompt and user message
					const messages = [
						{role:'system', 
						content: 'Eres un asistente que ayuda a encontrar municipios, procura ser útil y conciso pero humano.'+
								' Respondes solo preguntas relacionadas con municipios de la Comunidad de Madrid.'+
								' Si no sabes la respuesta, di que no lo sabes. Tus respuestas deben ser en español.'+
								' Tienes que devolver texto plano, sin italicas, negritas, ni formato especial.' +
								' Tienes que responder en el idioma de la pregunta.'
							},
						{role:'user', content: text}
					];
					reply = await callOpenRouterAPI(messages, apiKey);
				} else {
					// Dummy response
					reply = simulateAssistantReply(text);
				}
				if(lastPlaceholder) lastPlaceholder.textContent = reply;
			}catch(err){
				const fallback = simulateAssistantReply(text);
				if(lastPlaceholder) lastPlaceholder.textContent = fallback;
			}
		}

		// Initial assistant welcome message
		renderChatMessage('assistant', 'Hola, soy tu Asistente IA para ayudarte a saber más sobre los municipios. Pregúntame cualquier duda que tengas sobre ello.');

		document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
		document.getElementById('chatInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChatMessage(); } });

		// initial load
		runSearch({forceReload:true}).catch(err=>{ console.warn('Initial runSearch failed, falling back', err); loadFallback(); renderRanking(municipios,20); });
	</script>
</body>
</html>
